<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>BET300 ¬∑ Elegi tu beneficio</title>
<meta name="theme-color" content="#0a0f1f"/>
<style>
:root{
  --bg:#0b1020; --panel:#0f142b; --panel2:#0c1228; --border:#1b2350;
  --text:#eaf0ff; --muted:#a9afd6; --ok:#25D366; --accent:#7c4dff; --cyan:#22d3ee; --gold:#ffd166;
  --cardBack1:#0e1633; --cardBack2:#0b1331; --glow:#74b3ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:radial-gradient(1000px 600px at 10% -10%, #1a2050 0%, #0b1020 55%, #060a16 100%);
  color:var(--text);font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial
}
.container{max-width:1200px;margin:10px auto 90px;padding:0 12px}
.cardWrap{background:linear-gradient(180deg,rgba(124,77,255,.08),rgba(34,211,238,.08)),var(--panel2);border:1px solid var(--border);border-radius:18px;padding:12px;box-shadow:0 15px 40px rgba(0,0,0,.4)}
@media(min-width:980px){.grid{display:grid;grid-template-columns:1.05fr .95fr;gap:12px}}
.head{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px}
.brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.3px}
.badgeB{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#68a4ff,#7c59ff);display:grid;place-items:center;font-weight:900}
.brand b{font-size:22px}
.pill{background:linear-gradient(90deg,rgba(124,77,255,.16),rgba(0,209,255,.16));border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
.pill.time{display:flex;gap:6px;align-items:center}
.pill.sound{cursor:pointer;user-select:none}
.count{display:inline-flex;gap:6px;align-items:center;padding:3px 8px;border-radius:999px;background:rgba(255,204,0,.15);
  border:1px solid rgba(255,204,0,.35);color:#ffe27a;font-weight:800;font-variant-numeric:tabular-nums}
.rightTop{margin-left:auto;display:flex;gap:8px;align-items:center}
.btnLink{display:inline-flex;gap:8px;align-items:center;padding:10px 12px;border-radius:12px;font-weight:800;
  background:linear-gradient(90deg,#7c59ff,#00d1ff);color:#0a0f1f;text-decoration:none;border:1px solid rgba(255,255,255,.06)}

.panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px}
.center{text-align:left}
h1,h2,h3,p{margin:0 0 8px}
.muted{color:var(--muted)}

/* ====== Cartas ====== */
.cards{
  display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:8px
}
@media(max-width:720px){
  .cards{grid-template-columns:repeat(3,1fr);gap:10px}
}
.card{
  perspective:1100px;height:180px; /* m√°s compacto para reducir scroll */
}
@media(max-width:480px){ .card{height:150px} }
.cardInner{
  position:relative;width:100%;height:100%;transform-style:preserve-3d;transition:transform 620ms cubic-bezier(.2,.8,.2,1);
  border-radius:16px; box-shadow:0 10px 28px rgba(0,0,0,.35);
}
.cardInner.flip{ transform:rotateY(180deg) }
.face{
  position:absolute;inset:0;border-radius:16px;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:10px;
  border:1px solid #26306a; backface-visibility:hidden;
}
.face.back{
  background:radial-gradient(140% 120% at 50% 0%, #0f1a45 0%, #0b1331 60%, #070d24 100%);
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.03);
}
.face.back .logoBack{
  font-weight:900; letter-spacing:2px; font-size:28px; opacity:.9;
  background:linear-gradient(180deg,#9bd1ff,#8ba1ff 45%,#7c59ff);
  -webkit-background-clip:text; background-clip:text; color:transparent; filter:drop-shadow(0 0 10px rgba(116,179,255,.35));
  transform:scaleX(-1); /* BET300 espejado como naipe */
}
@media(max-width:480px){ .face.back .logoBack{font-size:22px}}
.face.front{
  transform:rotateY(180deg);
  background:
    radial-gradient(200px 140px at 50% -20%, rgba(255,255,255,.09), transparent 60%),
    linear-gradient(180deg, rgba(124,77,255,.18), rgba(34,211,238,.18)),
    linear-gradient(180deg,#0e1635,#0b1331);
}
.face.front .title{font-weight:900;font-size:18px;margin-bottom:6px}
.face.front .desc{font-size:13px;color:var(--muted)}
.cardInner.winner{ box-shadow:0 0 0 2px rgba(124,77,255,.6), 0 0 28px rgba(124,77,255,.35) inset, 0 10px 30px rgba(0,0,0,.4)}
.cardInner.loser{ opacity:.92 }

/* Dock inferior */
.dock{position:fixed;left:0;right:0;bottom:0;z-index:20;background:linear-gradient(180deg, rgba(11,15,30,0) 0%, rgba(11,15,30,.88) 24%, rgba(11,15,30,.96) 100%);
  padding:10px 12px 12px;display:flex;gap:10px;flex-wrap:wrap}
.btn{appearance:none;border:none;cursor:pointer;padding:12px 14px;border-radius:14px;font-weight:800;background:linear-gradient(90deg,#ff9a3d,#ff5c39);color:#0b0f1e;
  box-shadow:0 8px 20px rgba(0,0,0,.35)}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn.ok{background:#25D366;color:#0b0f1e}
.btn.platform{background:#2bdc6a;color:#07150d}

/* Modal premio */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(4,6,14,.6);backdrop-filter:blur(4px);z-index:60}
.modal.show{display:flex}
.modalCard{width:min(520px,92vw);background:var(--panel2);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 20px 50px rgba(0,0,0,.45)}
.modalHead{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.modalHead h3{margin:0;font-size:18px}
.modalBody{display:grid;gap:8px}
.row{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px dashed var(--border);border-radius:12px;padding:10px}
.k{color:var(--muted);font-size:13px}
.v{font-weight:800}
.actions{display:flex;gap:8px;margin-top:8px}
.btn.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
.closeX{margin-left:auto;cursor:pointer;opacity:.8}
.closeX:hover{opacity:1}

/* Compactaciones m√≥viles extra */
@media(max-width:520px){
  .panel{padding:10px}
  .cards{gap:8px}
}
</style>
</head>
<body>
<!-- MODAL PREMIO -->
<div id="prizeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modalCard">
    <div class="modalHead">
      <h3 id="modalTitle">üéÅ Beneficio obtenido</h3>
      <span id="closeModal" class="closeX">‚úñ</span>
    </div>
    <div class="modalBody">
      <div class="row"><span class="k">Beneficio</span><span class="v" id="mPrize">‚Äî</span></div>
      <div class="row"><span class="k">C√≥digo</span><span class="v" id="mCode">‚Äî</span></div>
      <div class="row"><span class="k">Fecha/Hora</span><span class="v" id="mTs">‚Äî</span></div>
      <div class="actions">
        <a id="goPlatform" class="btn platform" target="_blank" rel="noopener">üéÆ Ir a la plataforma</a>
        <button id="mAction" class="btn ok" style="display:none">üì≤ Pedir por WhatsApp</button>
        <button id="mClose" class="btn ghost">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="cardWrap">
    <div class="head">
      <div class="brand"><span class="badgeB">B3</span><b>BET300</b></div>
      <span class="pill">Cartas de beneficios</span>
      <span class="pill time">‚ö° Tiempo limitado <span class="count" id="countdown">--:--</span></span>
      <span class="pill sound" id="soundToggle">üîä Sonido: <b id="soundState">ON</b></span>
      <div class="rightTop">
        <a id="playNow" class="btnLink" target="_blank" rel="noopener"><span>üéÆ Plataforma</span></a>
        <a id="wpTop" class="btnLink" target="_blank" rel="noopener" style="background:linear-gradient(90deg,#25D366,#9BE69C)">üí¨ WhatsApp</a>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <h1>Eleg√≠ una carta y descubr√≠ tu beneficio</h1>
        <div id="cards" class="cards" aria-live="polite"></div>
        <p class="muted" style="margin-top:6px">Tip: mejor visual en vertical üì±</p>
      </div>

      <div class="panel">
        <div class="center">
          <div class="stat">
            <div>
              <div class="badge" id="badge" style="min-width:120px;height:40px;border-radius:10px;background:linear-gradient(90deg,#7c59ff,#00d1ff);display:grid;place-items:center;font-weight:900">-</div>
              <div class="smallline" id="stampLine" aria-live="polite"></div>
            </div>
            <div style="margin-top:6px">
              <h2 id="title">Ten√©s 1 intento disponible</h2>
              <p class="muted" id="subtitle">Los beneficios se aplican a tu <b>pr√≥xima carga</b>.</p>
            </div>
          </div>
        </div>

        <div class="panel" style="margin-top:8px">
          <p style="margin-bottom:6px"><b>Resultado actual</b></p>
          <p id="resultLine" class="muted">‚Äî</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Dock -->
<div class="dock">
  <button id="retryBtn" class="btn" style="flex:1;min-width:220px">üîÅ Reintentar (si sale ‚ÄúOtra chance‚Äù)</button>
  <a id="platformBtn" class="btn platform" style="flex:1;min-width:220px" target="_blank" rel="noopener">üåê Plataforma</a>
</div>

<script>
/* ===== Plataforma + WhatsApp por PC (4 par√°metros) ===== */
const PLATFORM_LINKS = {
  pc1: "https://plataforma-01.ejemplo.com/",
  pc2: "https://plataforma-02.ejemplo.com/",
  pc3: "https://plataforma-03.ejemplo.com/",
  pc4: "https://plataforma-04.ejemplo.com/",
};
const WP_NUMBERS = {
  pc1: "5491111111111",
  pc2: "5491122222222",
  pc3: "5491133333333",
  pc4: "5491144444444",
};
const params = new URLSearchParams(location.search);
const pcParam = (params.get("pc") || "1").trim();
const pcKey = "pc" + (pcParam.match(/^[1-4]$/) ? pcParam : "1");
document.getElementById("playNow").href = PLATFORM_LINKS[pcKey];
document.getElementById("platformBtn").href = PLATFORM_LINKS[pcKey];
document.getElementById("wpTop").href = `https://wa.me/${WP_NUMBERS[pcKey]}`;

/* ===== Utilidades base ===== */
const SALT = "bet300-cards-v2";
function ensureDeviceId(){
  let id = localStorage.getItem('device_id');
  if(!id){ id = (crypto.randomUUID?.() || `${Date.now()}-${Math.random().toString(36).slice(2,8)}`); localStorage.setItem('device_id', id); }
  return id;
}
const DEVICE_ID = ensureDeviceId();
function todayKey(){const n=new Date();return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`}
function tsString(d=new Date()){
  const dd=String(d.getDate()).padStart(2,'0'),mm=String(d.getMonth()+1).padStart(2,'0'),yyyy=d.getFullYear();
  const hh=String(d.getHours()).padStart(2,'0'),mi=String(d.getMinutes()).padStart(2,'0');
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}
async function sha256hex(msg){
  const enc = new TextEncoder().encode(msg);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function makeClaimCode(label){
  const base = `${DEVICE_ID}|${todayKey()}|${label}|pc:${pcParam}|${SALT}`;
  const hex = await sha256hex(base);
  return hex.slice(0,10).toUpperCase();
}
function logAudit(entry){
  const key='cards_audit';
  const arr = JSON.parse(localStorage.getItem(key) || "[]");
  arr.push(entry);
  localStorage.setItem(key, JSON.stringify(arr).slice(-5000)); // recorta a ~√∫ltimos 5k chars
}

/* ===== Sonido ===== */
let soundOn = true;
const soundToggle = document.getElementById('soundToggle');
const soundState  = document.getElementById('soundState');
const AudioKit = (()=>{ try{
  const Ctx = window.AudioContext || window.webkitAudioContext;
  const ctx = new Ctx(); let unlocked=false;
  function unlock(){ if(!unlocked){ ctx.resume().catch(()=>{}); unlocked=true; } }
  function click(freq=900,dur=0.035,vol=0.06){
    const o=ctx.createOscillator(), g=ctx.createGain(); o.type='square'; o.frequency.value=freq; g.gain.value=0; o.connect(g).connect(ctx.destination);
    const t=ctx.currentTime; g.gain.linearRampToValueAtTime(vol, t+0.005); g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
    o.start(t); o.stop(t+dur);
  }
  function win(){ [660,880,1320].forEach((f,i)=>setTimeout(()=>click(f,0.12,0.09), i*120)); }
  return {ctx,unlock,click,win};
}catch(e){return {unlock(){},click(){},win(){}} })();
document.addEventListener('click',()=>AudioKit.unlock(),{once:true});
soundToggle.addEventListener('click',()=>{ soundOn=!soundOn; soundState.textContent=soundOn?'ON':'OFF';});

/* ===== Countdown simple (3:59 demo) ===== */
const endTs = Date.now() + 4*60*1000;
function tickCountdown(){
  const ms=endTs-Date.now(); const total=Math.max(0,Math.floor(ms/1000));
  const m=Math.floor((total%3600)/60), s=total%60;
  document.getElementById('countdown').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
setInterval(tickCountdown,1000); tickCountdown();

/* ===== Beneficios (rotan de lugar en cada carga) ===== */
const PRIZES = [
  { id:'cofre',  title:'COFRE MISTERIOSO',  desc:'Premio asegurado.', kind:'landing', link:'#cofre' },
  { id:'memo',   title:'MEMO PLAY',         desc:'Prob√° suerte en el Memory.',      kind:'landing', link:'#memo' },
  { id:'otra',   title:'OTRA CHANCE',       desc:'Pod√©s elegir otra carta.',        kind:'retry'   },
  { id:'extra',  title:'30% EXTRA',         desc:'Pedilo por WhatsApp y aplic√° el extra en tu pr√≥xima carga.', kind:'whatsapp' },
  { id:'ruleta', title:'RULETA',            desc:'Acced√© a la ruleta de beneficios.', kind:'landing', link:'#ruleta' },
  { id:'slot',   title:'SLOT',              desc:'Gir√° por extra en la pr√≥xima carga.', kind:'landing', link:'#slot' },
];

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

/* ===== UI Refs ===== */
const cardsEl = document.getElementById('cards');
const badge   = document.getElementById('badge');
const title   = document.getElementById('title');
const subtitle= document.getElementById('subtitle');
const resultLine = document.getElementById('resultLine');
const stampEl = document.getElementById('stampLine');
const retryBtn= document.getElementById('retryBtn');

/* Modal */
const prizeModal = document.getElementById('prizeModal');
const mPrize = document.getElementById('mPrize');
const mCode  = document.getElementById('mCode');
const mTs    = document.getElementById('mTs');
const mAction= document.getElementById('mAction');
const mClose = document.getElementById('mClose');
const closeModalX = document.getElementById('closeModal');
const goPlatform = document.getElementById('goPlatform');

function openModal(prizeLabel, code, ts, prizeObj){
  mPrize.textContent = prizeLabel;
  mCode.textContent  = code;
  mTs.textContent    = ts;
  goPlatform.href = PLATFORM_LINKS[pcKey];

  // Solo para 30% EXTRA mostramos WhatsApp directo (seg√∫n PC)
  if(prizeObj?.id === 'extra'){
    mAction.style.display='';
    mAction.onclick = ()=> location.href=`https://wa.me/${WP_NUMBERS[pcKey]}?text=${encodeURIComponent('Hola! Quiero pedir mi 30% EXTRA de la promo de cartas (c√≥digo '+code+').')}`;
  }else{
    mAction.style.display='none';
  }
  prizeModal.classList.add('show');
}
function closeModal(){ prizeModal.classList.remove('show'); }
mClose.onclick = closeModal; closeModalX.onclick = closeModal;
prizeModal.addEventListener('click',e=>{ if(e.target===prizeModal) closeModal(); });

/* ===== Cartas ===== */
let picked=false, winnerIndex=null, mapIds=[];

// gira TODAS las cartas luego del premio (nuevo)
function flipAllAfterPrize(){
  document.querySelectorAll('.cardInner').forEach(el=>el.classList.add('flip'));
}

function buildCard(prize, index){
  const wrap = document.createElement('div'); wrap.className='card';
  const inner = document.createElement('div'); inner.className='cardInner'; wrap.appendChild(inner);

  const back = document.createElement('div'); back.className='face back';
  back.innerHTML = `<div class="logoBack">BET300</div>`;
  const front = document.createElement('div'); front.className='face front';
  front.innerHTML = `<div class="title">${prize.title}</div><div class="desc">${prize.desc}</div>`;

  inner.appendChild(back); inner.appendChild(front);

  wrap.addEventListener('click', async ()=>{
    if(picked && index!==winnerIndex) return;
    if(soundOn) AudioKit.click(980,.08,.09);

    // gira SOLO la tocada
    inner.classList.add('flip');

    // define ganador la 1¬™ vez de manera aleatoria (mantengo l√≥gica original)
    if(!picked){
      picked = true;
      winnerIndex = Math.floor(Math.random()*PRIZES.length);
      localStorage.setItem('cards_winnerIndex', String(winnerIndex));
    }

    // marca winner/loser visualmente
    const inners=[...document.querySelectorAll('.cardInner')];
    inners.forEach((el,i)=> el.classList.toggle('winner', i===winnerIndex));
    inners.forEach((el,i)=> el.classList.toggle('loser',  i!==winnerIndex));

    // otorga premio
    await grantPrize(PRIZES[winnerIndex]);

    // AHORA: gira TODAS para mostrar opciones
    setTimeout(flipAllAfterPrize, 250);
  });

  return wrap;
}

function renderCards(){
  cardsEl.innerHTML='';
  const shuffled = shuffle(PRIZES.slice());
  mapIds = shuffled.map(p=>p.id);
  shuffled.forEach((p,i)=> cardsEl.appendChild(buildCard(p,i)));
}

async function grantPrize(prize){
  const ts   = tsString(new Date());
  const code = await makeClaimCode(prize.title);
  localStorage.setItem('cards_done','1');
  localStorage.setItem('cards_prize', JSON.stringify(prize));
  localStorage.setItem('cards_code', code);
  localStorage.setItem('cards_ts', ts);

  badge.textContent = prize.title;
  title.textContent = prize.title === 'OTRA CHANCE' ? 'üéØ ¬°Otra chance habilitada!' : `üéâ ${prize.title}`;
  subtitle.innerHTML = (prize.id==='extra') ? 'Pedilo por <b>WhatsApp</b>.' : 'Usalo desde su landing o plataforma.';
  resultLine.textContent = `Resultado: ${prize.title}`;
  stampEl.textContent = `C√≥digo: ${code} ¬∑ ${ts}`;

  // log auditor√≠a
  logAudit({when:Date.now(), prize:prize.id, code, map:mapIds});

  // bot√≥n ‚Äúreintentar‚Äù solo si sale otra chance
  retryBtn.disabled = (prize.id!=='otra');

  if(soundOn) AudioKit.win();

  // Modal con acci√≥n especial si corresponde
  openModal(prize.title, code, ts, prize);
}

function showSaved(){
  const done=localStorage.getItem('cards_done')==='1';
  const saved=localStorage.getItem('cards_prize');
  if(done && saved){
    const p=JSON.parse(saved);
    const code = localStorage.getItem('cards_code') || '‚Äî';
    const ts   = localStorage.getItem('cards_ts')   || tsString();
    badge.textContent=p.title; title.textContent = p.title==='OTRA CHANCE'?'üéØ ¬°Otra chance habilitada!':`üéâ ${p.title}`;
    subtitle.innerHTML = (p.id==='extra') ? 'Pedilo por <b>WhatsApp</b>.' : 'Usalo desde su landing o plataforma.';
    stampEl.textContent=`C√≥digo: ${code} ¬∑ ${ts}`;
    resultLine.textContent=`Resultado: ${p.title}`;
    retryBtn.disabled = (p.id!=='otra');

    // visual: todas dadas vuelta para mostrar opciones
    setTimeout(flipAllAfterPrize, 0);
  }
}

retryBtn.addEventListener('click', ()=>{
  const done=localStorage.getItem('cards_done')==='1';
  const saved=localStorage.getItem('cards_prize');
  if(!(done && saved)) return;

  const p=JSON.parse(saved);
  if(p.id!=='otra'){ alert('Solo disponible si sali√≥ "Otra chance".'); return; }

  // reset del intento (conservar d√≠a)
  localStorage.removeItem('cards_done');
  localStorage.removeItem('cards_prize');
  localStorage.removeItem('cards_code');
  localStorage.removeItem('cards_ts');

  // reset visual
  picked=false; winnerIndex=null;
  renderCards();
  badge.textContent='-'; title.textContent='Ten√©s 1 intento disponible';
  subtitle.innerHTML='Los beneficios se aplican a tu <b>pr√≥xima carga</b>.';
  stampEl.textContent=''; resultLine.textContent='‚Äî';
  retryBtn.disabled=true;
});

/* ===== Init ===== */
function init(){
  renderCards();
  showSaved();
}
init();
</script>
</body>
</html>
