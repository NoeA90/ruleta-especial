<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>BET300 ¬∑ Ruleta Edici√≥n Especial</title>
<meta name="theme-color" content="#0a0f1f"/>
<style>
:root{
  --bg:#0a0f1f; --panel:#0f132b; --panel2:#0b1026; --border:#1a2250;
  --text:#e9ecff; --muted:#aab0d6; --ok:#25D366; --accent:#7c4dff; --cyan:#22d3ee; --gold:#ffd166;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto}
body::before{content:"";position:fixed;inset:0;z-index:-2;background:
  radial-gradient(900px 500px at 70% -10%, rgba(124,77,255,.25), transparent),
  radial-gradient(700px 350px at 0% 0%, rgba(0,209,255,.18), transparent),
  linear-gradient(180deg,#0a0f1f 0%,#0a0f1f 60%,#080c1a 100%);
}
.container{max-width:980px;margin:6px auto 86px;padding:0 10px}
.card{background:
  radial-gradient(120% 100% at 50% 0%, rgba(124,77,255,.09), transparent),
  var(--panel2);
  border:1px solid var(--border);border-radius:18px;padding:10px;box-shadow:0 15px 40px rgba(0,0,0,.35)}
@media(min-width:900px){.grid{display:grid;grid-template-columns:1.05fr .95fr;gap:10px}}
@media(max-width:520px){.card{border-radius:0;border-left:0;border-right:0}}

.head{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:6px}
.brand{font-weight:900;letter-spacing:.5px;font-size:22px}
.pill{background:linear-gradient(90deg,rgba(124,77,255,.13),rgba(0,209,255,.13));border:1px solid var(--border);
  border-radius:999px;padding:6px 8px;font-size:12px;color:var(--muted)}
.pill.time{display:flex;gap:6px;align-items:center}
.pill.sound{cursor:pointer;user-select:none}
.count{display:inline-flex;gap:6px;align-items:center;padding:3px 8px;border-radius:999px;background:rgba(255,204,0,.15);
  border:1px solid rgba(255,204,0,.35);color:#ffe27a;font-weight:700;font-variant-numeric:tabular-nums}
h1,h2,h3,p{margin:0 0 6px}
h1{font-size:20px}
.muted{color:var(--muted)}
.rightTop{margin-left:auto;display:flex;gap:8px;align-items:center}
.btnLink{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:12px;font-weight:800;
  background:linear-gradient(90deg,#7c59ff,#00d1ff);color:#0a0f1f;text-decoration:none;border:1px solid rgba(255,255,255,.06)}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px}
.center{text-align:center}
.stat{display:flex;gap:10px;align-items:center;justify-content:center;margin:6px 0 8px}
.badge{min-width:66px;height:40px;border-radius:10px;background:radial-gradient(100% 100% at 50% 0%, rgba(0,209,255,.35), rgba(124,77,255,.35));
  display:grid;place-items:center;font-weight:800;font-size:16px;box-shadow:inset 0 0 10px rgba(124,77,255,.35)}
.smallline{font-size:12px;color:var(--muted)}
.stage{display:flex;justify-content:center}
.ruletaWrap{width:100%;max-width:520px;margin:4px auto 0;position:relative}
.slot{position:relative;border-radius:16px;padding:10px;background:
  linear-gradient(180deg,rgba(124,77,255,.18),rgba(34,211,238,.18));
  border:1px solid var(--border);box-shadow:inset 0 0 0 1px rgba(255,255,255,.03), 0 10px 30px rgba(0,0,0,.35)}
.ruletaFrame{position:relative;border-radius:14px;padding:10px;background:rgba(10,15,35,.65);
  border:1px solid #2a2f58;display:grid;place-items:center}
.canvasBox{position:relative;width:100%;max-width:420px;aspect-ratio:1}
canvas#wheel{width:100%;height:100%;display:block;border-radius:50%;background:radial-gradient(60% 60% at 50% 40%, #10163a 0%, #0a112f 70%, #09102a 100%)}
.pointer{position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:18px solid #ffd166;filter:drop-shadow(0 0 6px rgba(255,209,102,.8))}
.betLogo{
  position:absolute;inset:0;display:grid;place-items:center;pointer-events:none;
}
.betLogo i{
  display:inline-block;
  padding:16px 18px 14px;
  border-radius:999px;
  background:radial-gradient(100% 100% at 50% 0%, rgba(255,255,255,.15), rgba(255,255,255,.02)),
             linear-gradient(180deg,#7c59ff 0%,#22d3ee 100%);
  color:#0a0f1f;
  font-weight:900; letter-spacing:1px;
  text-shadow:0 2px 10px rgba(0,0,0,.35);
  box-shadow:0 0 0 6px rgba(124,77,255,.15), 0 0 40px rgba(124,77,255,.35), inset 0 0 18px rgba(255,255,255,.25);
}
.betLogo i b{display:block;font-size:28px;line-height:1}
.betLogo i span{display:block;font-size:40px;line-height:1;margin-top:2px}
.glowRing{
  position:absolute;inset:14% 14%;
  border-radius:50%;
  box-shadow:0 0 35px 12px rgba(124,77,255,.25), 0 0 60px 20px rgba(34,211,238,.18);
  pointer-events:none;
}

.hint{text-align:center;color:var(--muted);font-size:12px;margin-top:4px}

/* Dock inferior */
.dock{position:fixed;left:0;right:0;bottom:0;z-index:20;background:linear-gradient(180deg, rgba(11,15,30,0) 0%, rgba(11,15,30,.85) 22%, rgba(11,15,30,.95) 100%);
  padding:8px 10px 10px;display:flex;gap:8px}
.btn{appearance:none;border:none;cursor:pointer;padding:12px 14px;border-radius:14px;font-weight:800;background:linear-gradient(90deg,#ff9a3d,#ff5c39);color:#0b0f1e;width:100%;
  box-shadow:0 8px 20px rgba(0,0,0,.35)}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn.ok{background:#25D366;color:#0b0f1e}

.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(4,6,14,.6);backdrop-filter:blur(4px);z-index:60}
.modal.show{display:flex}
.modalCard{width:min(520px,92vw);background:var(--panel2);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 20px 50px rgba(0,0,0,.45)}
.modalHead{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.modalHead h3{margin:0;font-size:18px}
.modalBody{display:grid;gap:8px}
.row{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px dashed var(--border);border-radius:12px;padding:10px}
.k{color:var(--muted);font-size:13px}
.v{font-weight:800}
.actions{display:flex;gap:8px;margin-top:8px}
.btn.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
.closeX{margin-left:auto;cursor:pointer;opacity:.8}
.closeX:hover{opacity:1}

/* Compacto m√≥vil */
@media(max-width:420px){
  h1{font-size:18px}
  .panel{padding:8px}
  .stat{gap:8px}
  .badge{min-width:60px;height:36px;font-size:15px}
  .btn{padding:11px 12px}
}
</style>
</head>
<body>
<!-- MODAL -->
<div id="prizeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modalCard">
    <div class="modalHead">
      <h3 id="modalTitle">üéÅ Premio obtenido</h3>
      <span id="closeModal" class="closeX">‚úñ</span>
    </div>
    <div class="modalBody">
      <div class="row"><span class="k">Premio</span><span class="v" id="mPrize">‚Äî</span></div>
      <div class="row"><span class="k">C√≥digo</span><span class="v" id="mCode">‚Äî</span></div>
      <div class="row"><span class="k">Fecha/Hora</span><span class="v" id="mTs">‚Äî</span></div>
      <div class="actions">
        <a id="mGoGame" class="btn">üïπÔ∏è Ir al juego</a>
        <a id="mPlatform" class="btn ok" target="_blank" rel="noopener">üåê Abrir plataforma</a>
        <button id="mClose" class="btn ghost">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="card">
    <div class="head">
      <div class="brand">BET300</div>
      <span class="pill">Ruleta ¬∑ Edici√≥n Especial</span>
      <span class="pill time">‚ö° Tiempo limitado <span class="count" id="countdown">--:--</span></span>
      <span class="pill sound" id="soundToggle">üîä Sonido: <b id="soundState">ON</b></span>
      <div class="rightTop">
        <a id="playNow" class="btnLink" target="_blank" rel="noopener"><span>üéÆ Entrar a la plataforma</span></a>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <h1>Ruleta BET300 ¬∑ </h1>
        <div class="stage">
          <div class="ruletaWrap slot" id="ruletaBox">
            <div class="ruletaFrame">
              <div class="canvasBox">
                <div class="pointer"></div>
                <canvas id="wheel" width="720" height="720"></canvas>

                <!-- BET300 grande y luminoso -->
                <div class="glowRing"></div>
                <div class="betLogo"><i><b>BET</b><span>300</span></i></div>
              </div>
            </div>
            <div class="hint" id="hint">Tip: mejor visual en vertical üì±</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="center">
          <div class="stat">
            <div>
              <div class="badge" id="badge">-</div>
              <div class="smallline" id="stampLine" aria-live="polite"></div>
            </div>
            <div>
              <h2 id="title">Ten√©s 1 giro disponible</h2>
              <p class="muted" id="subtitle">Los premios se acreditan como indica cada juego/landing.</p>
            </div>
          </div>
        </div>

        <div class="panel" style="margin-top:6px">
          <p style="margin-bottom:6px"><b>Resultado actual</b></p>
          <p id="resultLine" class="muted">‚Äî</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Dock -->
<div class="dock">
  <button id="spinBtn" class="btn">üéØ Girar</button>
</div>

<script>
/* ===== Plataforma por PC (4 par√°metros: ?pc=1|2|3|4) ===== */
const PLATFORM_LINKS = {
  pc1: "https://c01.bet300vip.com/",
  pc2: "https://c02.bet300vip.com/",
  pc3: "https://c03.bet300vip.com/",
  pc4: "https://c04.bet300vip.com/"
};
const params = new URLSearchParams(location.search);
const pcParam = (params.get("pc") || "1").trim();
const pcKey = "pc" + (pcParam.match(/^[1-4]$/) ? pcParam : "1");
const PLATFORM_BASE = PLATFORM_LINKS[pcKey];
document.getElementById("playNow").href = PLATFORM_BASE;
document.getElementById("mPlatform").href = PLATFORM_BASE;

/* ===== Sonido ===== */
let soundOn = true;
const soundToggle = document.getElementById('soundToggle');
const soundState  = document.getElementById('soundState');
const AudioKit = (()=>{
  const Ctx = window.AudioContext || window.webkitAudioContext;
  const ctx = new Ctx(); let unlocked=false;
  function unlock(){ if(!unlocked){ ctx.resume().catch(()=>{}); unlocked=true; } }
  function blip(freq=900,dur=0.035,vol=0.06){
    const o=ctx.createOscillator(), g=ctx.createGain(); o.type='square'; o.frequency.value=freq; g.gain.value=0; o.connect(g).connect(ctx.destination);
    const t=ctx.currentTime; g.gain.linearRampToValueAtTime(vol, t+0.003); g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
    o.start(t); o.stop(t+dur);
  }
  function spinLoop(){ const id=setInterval(()=>blip(820+Math.random()*220,0.028,0.05),80); return ()=>clearInterval(id); }
  function win(){ [660,880,1320].forEach((f,i)=>setTimeout(()=>blip(f,0.12,0.09), i*120)); }
  return {ctx,unlock,spinLoop,win};
})();
document.addEventListener('click',()=>AudioKit.unlock(),{once:true});
soundToggle.addEventListener('click',()=>{ soundOn=!soundOn; soundState.textContent=soundOn?'ON':'OFF';});

/* ===== Antifraude / util ===== */
const SALT = "bet300-ruleta-v1";
function ensureDeviceId(){
  let id = localStorage.getItem('device_id');
  if(!id){ id = (crypto.randomUUID?.() || `${Date.now()}-${Math.random().toString(36).slice(2,8)}`); localStorage.setItem('device_id', id); }
  return id;
}
const DEVICE_ID = ensureDeviceId();
function todayKey(){const n=new Date();return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;}
function tsString(d=new Date()){
  const dd=String(d.getDate()).padStart(2,'0'),mm=String(d.getMonth()+1).padStart(2,'0'),yyyy=d.getFullYear();
  const hh=String(d.getHours()).padStart(2,'0'),mi=String(d.getMinutes()).padStart(2,'0');
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}
async function sha256hex(msg){
  const enc = new TextEncoder().encode(msg);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function makeClaimCode(prizeLabel){
  const base = `${DEVICE_ID}|${todayKey()}|${prizeLabel}|${pcKey}|${SALT}`;
  const hex = await sha256hex(base);
  return hex.slice(0,10).toUpperCase();
}
function money(n){ return "$"+n.toLocaleString("es-AR"); }

/* ===== Cuenta regresiva al fin del d√≠a ===== */
function endOfDay(){const n=new Date();const end=new Date(n.getFullYear(),n.getMonth(),n.getDate(),23,59,0,0).getTime();
  return end>Date.now()?end:new Date(n.getFullYear(),n.getMonth(),n.getDate()+1,23,59,0,0).getTime()}
function tickCountdown(){
  const ms=endOfDay()-Date.now(); const total=Math.max(0,Math.floor(ms/1000));
  const h=Math.floor(total/3600), m=Math.floor((total%3600)/60), s=total%60;
  document.getElementById('countdown').textContent=h>0?`${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`:`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

/* ===== Ruleta (canvas) ===== */
const wheel = document.getElementById('wheel');
const ctx = wheel.getContext('2d');
const W = wheel.width, H = wheel.height, CX=W/2, CY=H/2, R=Math.min(CX,CY)-16;
const SEGMENTS = [
  { label:"Memo Play", color:"#4fc3f7", path:"memory" },
  { label:"Cofre Misterioso", color:"#7e57c2", path:"cofre" },
  { label:"Slot Extra", color:"#26c6da", path:"slot" },
  { label:"30% Extra", color:"#ffd166", path:"bonus30" },
  { label:"Ruleta Bonus", color:"#ef6c00", path:"ruleta2" },
  { label:"Otra Chance", color:"#66bb6a", path:null } // null = vuelve a girar
];
const N = SEGMENTS.length;
let angle = -Math.PI/2; // 12 en punto
let spinning = false;

function drawWheel(a=angle){
  ctx.clearRect(0,0,W,H);
  const step = Math.PI*2/N;
  for(let i=0;i<N;i++){
    const start = a + i*step;
    const end   = start + step;
    // sector
    ctx.beginPath();
    ctx.moveTo(CX,CY);
    ctx.arc(CX,CY,R,start,end);
    ctx.closePath();
    const grad = ctx.createLinearGradient(CX,CY-R,CX,CY+R);
    grad.addColorStop(0, SEGMENTS[i].color);
    grad.addColorStop(1, "rgba(255,255,255,.08)");
    ctx.fillStyle = grad;
    ctx.fill();
    ctx.lineWidth = 2;
    ctx.strokeStyle = "rgba(255,255,255,.12)";
    ctx.stroke();

    // texto
    ctx.save();
    const mid = (start+end)/2;
    ctx.translate(CX + Math.cos(mid)*(R*0.68), CY + Math.sin(mid)*(R*0.68));
    ctx.rotate(mid + Math.PI/2);
    ctx.fillStyle="#e9ecff";
    ctx.font="700 24px system-ui,Segoe UI,Roboto";
    let txt = SEGMENTS[i].label;
    // recorte simple para m√≥viles
    if(wheel.clientWidth < 340 && txt.length>12) txt = txt.slice(0,12)+"‚Ä¶";
    ctx.textAlign="center";
    ctx.fillText(txt,0,8);
    ctx.restore();
  }
  // aro externo
  ctx.beginPath();
  ctx.arc(CX,CY,R+6,0,Math.PI*2);
  ctx.strokeStyle="rgba(124,77,255,.45)";
  ctx.lineWidth=6;
  ctx.stroke();
}

function pickWinnerIndex(){
  // Probabilidades iguales; si quer√©s ponderar, ajust√° aqu√≠
  return Math.floor(Math.random()*N);
}

function spinTo(index){
  const step = Math.PI*2/N;
  // Queremos que el centro del segmento ganador quede en la punta (12 en punto = -œÄ/2 en nuestro sistema)
  const targetSegCenter = index*step + step/2;
  // Nuestro √°ngulo base arranca en -œÄ/2, as√≠ que offset para que (a + target) == -œÄ/2 (mod 2œÄ)
  // => a_final = -œÄ/2 - targetSegCenter + k*2œÄ
  const rotations = 6 + Math.floor(Math.random()*3); // 6..8 vueltas
  const finalAngle = -Math.PI/2 - targetSegCenter + rotations*(Math.PI*2);
  const startAngle = angle;
  const delta = finalAngle - startAngle;
  const dur = 2200; // ms
  const start = performance.now();
  let stopSound=null; if(soundOn) stopSound = AudioKit.spinLoop();

  function anim(t){
    const k = Math.min(1,(t-start)/dur);
    // easeOutCubic
    const e = 1 - Math.pow(1-k,3);
    angle = startAngle + delta*e;
    drawWheel(angle);
    if(k<1){ requestAnimationFrame(anim); }
    else{
      if(soundOn && stopSound) stopSound();
      onWin(index);
    }
  }
  requestAnimationFrame(anim);
}

/* ===== Modal ===== */
const prizeModal = document.getElementById('prizeModal');
const mPrize = document.getElementById('mPrize');
const mCode  = document.getElementById('mCode');
const mTs    = document.getElementById('mTs');
const mGoGame = document.getElementById('mGoGame');
const mPlatform = document.getElementById('mPlatform');
const mClose = document.getElementById('mClose');
const closeModalX = document.getElementById('closeModal');

function openModal(prizeLabel, code, ts, gameUrl){
  mPrize.textContent = prizeLabel;
  mCode.textContent  = code;
  mTs.textContent    = ts;
  if(gameUrl){
    mGoGame.href = gameUrl;
    mGoGame.style.display = '';
  }else{
    mGoGame.removeAttribute('href');
    mGoGame.style.display = 'none';
  }
  prizeModal.classList.add('show');
}
function closeModal(){ prizeModal.classList.remove('show'); }
mClose.onclick = closeModal; closeModalX.onclick = closeModal;
prizeModal.addEventListener('click',e=>{ if(e.target===prizeModal) closeModal(); });

/* ===== UI ===== */
const spinBtn = document.getElementById('spinBtn');
const badge   = document.getElementById('badge');
const title   = document.getElementById('title');
const subtitle= document.getElementById('subtitle');
const resultLine = document.getElementById('resultLine');
const stampEl = document.getElementById('stampLine');
const hintEl = document.getElementById('hint');

function confettiBurst(){
  const n=28; const el=document.body; // simple body burst
  for(let i=0;i<n;i++){
    const p=document.createElement('i');
    p.style.position='fixed'; p.style.top='-20px'; p.style.left=(Math.random()*100)+'vw';
    p.style.width='10px'; p.style.height='14px'; p.style.borderRadius='2px';
    p.style.background = Math.random()<.5?'linear-gradient(#80ffea,#4e9cff)':'linear-gradient(#ffd166,#ff3d7f)';
    p.style.opacity='0';
    p.style.zIndex='40';
    p.style.animation=`confFall ${1.6+Math.random()*0.4}s linear forwards ${Math.random()*0.4}s`;
    el.appendChild(p);
    setTimeout(()=>p.remove(),2200);
  }
}

function restoreDaily(){
  const today=todayKey(); const stored=localStorage.getItem('wheel_date');
  if(stored && stored!==today){
    localStorage.removeItem('wheel_done');
    localStorage.removeItem('wheel_prize');
    localStorage.removeItem('wheel_code');
    localStorage.removeItem('wheel_ts');
    localStorage.setItem('wheel_date',today);
  }else if(!stored){ localStorage.setItem('wheel_date',today); }
}
function restorePrizeIfAny(){
  const done=localStorage.getItem('wheel_done')==='1'; const saved=localStorage.getItem('wheel_prize');
  if(done && saved){
    const p=JSON.parse(saved);
    const code = localStorage.getItem('wheel_code') || '‚Äî';
    const ts   = localStorage.getItem('wheel_ts')   || tsString();
    badge.textContent=p.label||'-'; title.textContent="üéâ ¬°Premio obtenido!";
    subtitle.textContent="Guardado. Pod√©s abrir la plataforma desde el bot√≥n.";
    stampEl.textContent=`C√≥digo: ${code} ¬∑ ${ts}`;
    spinBtn.disabled=true;
  }
}

/* ===== Resultado / Ganador ===== */
async function onWin(index){
  const seg = SEGMENTS[index];
  const prizeLabel = seg.label;
  const ts = tsString(new Date());
  const code = await makeClaimCode(prizeLabel);

  resultLine.textContent = `Resultado: ${prizeLabel}`;
  if(soundOn) AudioKit.win();
  confettiBurst();

  // Guardado y bloqueo diario, excepto "Otra Chance"
  if(prizeLabel !== "Otra Chance"){
    localStorage.setItem('wheel_prize', JSON.stringify({label:prizeLabel}));
    localStorage.setItem('wheel_code', code);
    localStorage.setItem('wheel_ts', ts);
    localStorage.setItem('wheel_done', '1');
    spinBtn.disabled = true;
    title.textContent = "üéâ ¬°Premio obtenido!";
  }else{
    title.textContent = "üîÅ ¬°Otra chance!";
  }

  const gameUrl = seg.path ? (PLATFORM_BASE.replace(/\/+$/,'') + '/' + seg.path) : null;
  openModal(prizeLabel, code, ts, gameUrl);
}

/* ===== Spin ===== */
spinBtn.addEventListener('click', ()=>{
  if(spinning) return;
  if(localStorage.getItem('wheel_done')==='1'){ alert("Ya usaste tu giro de hoy"); return; }
  spinning = true; hintEl.textContent='‚Äî';
  const idx = pickWinnerIndex();
  spinTo(idx);
  setTimeout(()=>{ spinning=false; }, 2400);
});

/* ===== Init ===== */
function init(){
  drawWheel();
  restoreDaily(); restorePrizeIfAny(); tickCountdown();
  setInterval(tickCountdown,1000);
}
init();

/* ===== Anim confetti (keyframes) ===== */
const style = document.createElement('style');
style.textContent = `
@keyframes confFall{8%{opacity:1}100%{transform:translateY(110vh) rotate(360deg);opacity:0}}
`;
document.head.appendChild(style);
</script>
</body>
</html>
