<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>BET300 ¬∑ Ruleta de la Suerte</title>
<meta name="theme-color" content="#FF7A1A"/>
<style>
:root{
  --bg1:#FFB86C; --bg2:#FF7A1A; --bg3:#FF5E00;
  --panel:#1a1325; --panel2:#140f22; --border:#2b2445;
  --text:#fff7f0; --muted:#e9d8c8;
  --accent:#00d1ff; /* bot. plataforma */
  --btn:#ffd166; --btn2:#22d3ee;
  --ok:#25D366; --shadow:rgba(0,0,0,.4);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--text);font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto;
  background:
    radial-gradient(1200px 700px at 80% -10%, rgba(255,255,255,.22), transparent),
    radial-gradient(900px 500px at 0% 0%, rgba(255,255,255,.12), transparent),
    linear-gradient(180deg,var(--bg1) 0%,var(--bg2) 55%,var(--bg3) 100%);
}
.container{max-width:980px;margin:8px auto 90px;padding:0 10px}
.card{
  background:
    radial-gradient(120% 100% at 50% 0%, rgba(255,255,255,.10), transparent),
    var(--panel2);
  border:1px solid var(--border);border-radius:18px;padding:12px;box-shadow:0 15px 40px var(--shadow)
}
@media(min-width:900px){.grid{display:grid;grid-template-columns:1.05fr .95fr;gap:12px}}
@media(max-width:520px){.card{border-radius:0;border-left:0;border-right:0}}

.head{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px}
.brand{
  position:relative; font-weight:1000; letter-spacing:.8px; font-size:26px; padding:6px 12px;
  color:#fff; text-shadow:0 0 12px rgba(255,255,255,.8), 0 0 24px #ffd166, 0 0 40px #ff8a1a;
  background:linear-gradient(90deg, rgba(255,215,130,.25), rgba(255,122,26,.18));
  border:1px solid rgba(255,255,255,.25); border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.35), inset 0 0 16px rgba(255,165,0,.25)
}
.pill{background:linear-gradient(90deg,rgba(255,255,255,.15),rgba(255,255,255,.08));border:1px solid var(--border);
  border-radius:999px;padding:6px 9px;font-size:12px;color:var(--muted)}
.pill.time{display:flex;gap:6px;align-items:center}
.pill.sound{cursor:pointer;user-select:none}
.count{display:inline-flex;gap:6px;align-items:center;padding:3px 8px;border-radius:999px;background:rgba(255,255,255,.18);
  border:1px solid rgba(255,255,255,.35);color:#fff;font-weight:800;font-variant-numeric:tabular-nums}
.rightTop{margin-left:auto;display:flex;gap:8px;align-items:center}
.btnLink{
  display:inline-flex;gap:8px;align-items:center;padding:9px 12px;border-radius:12px;font-weight:900;
  background:linear-gradient(90deg,#00d1ff,#6df7ff);color:#04232b;text-decoration:none;border:1px solid rgba(255,255,255,.18)
}
.btnWhats{
  display:inline-flex;gap:8px;align-items:center;padding:9px 12px;border-radius:12px;font-weight:900;
  background:linear-gradient(90deg,#25D366,#7CF7A3);color:#041b10;text-decoration:none;border:1px solid rgba(255,255,255,.18)
}

.panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px}
.center{text-align:center}
.stat{display:flex;gap:12px;align-items:center;justify-content:center;margin:6px 0 10px}
.badge{min-width:72px;height:44px;border-radius:10px;background:radial-gradient(100% 100% at 50% 0%, rgba(255,255,255,.25), rgba(255,255,255,.08));
  display:grid;place-items:center;font-weight:900;font-size:17px;box-shadow:inset 0 0 10px rgba(255,255,255,.25)}
.smallline{font-size:12px;color:var(--muted)}
h1,h2,h3,p{margin:0 0 6px}
h1{font-size:20px}
.muted{color:var(--muted)}

/* ===== Escena Ruleta ===== */
.stage{display:flex;justify-content:center}
.ruletaWrap{width:100%;max-width:520px;margin:6px auto 0;position:relative}
.wheelBox{position:relative;border-radius:16px;padding:10px;background:
  linear-gradient(180deg,rgba(255,255,255,.15),rgba(255,255,255,.06));
  border:1px solid var(--border);box-shadow:inset 0 0 0 1px rgba(255,255,255,.06), 0 10px 30px rgba(0,0,0,.35)}
canvas#wheel{width:100%;max-width:520px;height:auto;display:block;background:transparent}
.pointer{
  position:absolute;top:8px;left:50%;transform:translateX(-50%);
  width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:22px solid #fff;filter:drop-shadow(0 2px 6px rgba(0,0,0,.5))
}
.hint{text-align:center;color:var(--muted);font-size:12px;margin-top:6px}

/* FX l√≠nea ganadora (contorno del segmento) */
.highlight{
  position:absolute;inset:10px;pointer-events:none;border-radius:14px;
}
#winGlow{position:absolute;inset:0;border-radius:14px;box-shadow:0 0 0 0 rgba(255,255,255,0);transition:box-shadow .25s ease}

/* Dock inferior */
.dock{position:fixed;left:0;right:0;bottom:0;z-index:20;background:linear-gradient(180deg, rgba(20,12,4,0) 0%, rgba(20,12,4,.85) 22%, rgba(20,12,4,.95) 100%);
  padding:8px 10px 12px;display:flex;gap:8px;flex-wrap:wrap}
.btn{appearance:none;border:none;cursor:pointer;padding:12px 14px;border-radius:14px;font-weight:900;background:linear-gradient(90deg,#ffcc6b,#ff8a1a);color:#2b1700;box-shadow:0 8px 20px rgba(0,0,0,.35)}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn.alt{background:linear-gradient(90deg,#00d1ff,#6df7ff);color:#04232b}
.btn.ok{background:linear-gradient(90deg,#25D366,#7CF7A3);color:#041b10}

/* Confetti */
.confetti{position:fixed;inset:0;pointer-events:none;z-index:40}
.confetti i{position:absolute;top:-20px;width:10px;height:14px;border-radius:2px;opacity:0;animation:confFall 1.6s linear forwards}
@keyframes confFall{8%{opacity:1}100%{transform:translateY(110vh) rotate(360deg);opacity:0}}

/* Modal premio */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(4,6,14,.55);backdrop-filter:blur(4px);z-index:60}
.modal.show{display:flex}
.modalCard{width:min(520px,92vw);background:var(--panel2);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 20px 50px rgba(0,0,0,.45)}
.modalHead{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.modalHead h3{margin:0;font-size:18px}
.modalBody{display:grid;gap:8px}
.row{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px dashed var(--border);border-radius:12px;padding:10px}
.k{color:var(--muted);font-size:13px}
.v{font-weight:800}
.actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.btn.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
.closeX{margin-left:auto;cursor:pointer;opacity:.8}
.closeX:hover{opacity:1}

/* Compacto m√≥vil */
@media(max-width:420px){
  h1{font-size:18px}
  .panel{padding:8px}
  .stat{gap:8px}
  .badge{min-width:60px;height:36px;font-size:15px}
  .btn{padding:11px 12px}
}
</style>
</head>
<body>
<div id="confetti" class="confetti" aria-hidden="true"></div>

<!-- MODAL PREMIO -->
<div id="prizeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modalCard">
    <div class="modalHead">
      <h3 id="modalTitle">üéÅ Premio obtenido</h3>
      <span id="closeModal" class="closeX">‚úñ</span>
    </div>
    <div class="modalBody">
      <div class="row"><span class="k">Premio</span><span class="v" id="mPrize">‚Äî</span></div>
      <div class="row"><span class="k">C√≥digo</span><span class="v" id="mCode">‚Äî</span></div>
      <div class="row"><span class="k">Fecha/Hora</span><span class="v" id="mTs">‚Äî</span></div>
      <div class="actions">
        <a id="mToGame" class="btn">üïπÔ∏è Ir al juego</a>
        <a id="mToPlatform" class="btn alt">üåê Ir a la plataforma</a>
        <a id="mWhats" class="btn ok">üì≤ WhatsApp</a>
        <button id="mClose" class="btn ghost">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="card">
    <div class="head">
      <div class="brand">BET300</div>
      <span class="pill">Ruleta de la Suerte</span>
      <span class="pill time">‚ö° Tiempo limitado <span class="count" id="countdown">--:--</span></span>
      <span class="pill sound" id="soundToggle">üîä Sonido: <b id="soundState">ON</b></span>
      <div class="rightTop">
        <a id="playNow" class="btnLink" target="_blank" rel="noopener"><span>üåê Entrar a la plataforma</span></a>
        <a id="whatsTop" class="btnWhats" target="_blank" rel="noopener">üì≤ WhatsApp</a>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <h1>Gir√° y obten√© beneficios para tu pr√≥xima carga</h1>
        <div class="stage">
          <div class="ruletaWrap wheelBox" id="wheelBox">
            <div class="pointer"></div>
            <canvas id="wheel" width="520" height="520"></canvas>
            <div class="highlight"><div id="winGlow"></div></div>
            <div class="hint" id="hint">Tip: mejor visual en vertical üì±</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="center">
          <div class="stat">
            <div>
              <div class="badge" id="badge">‚Äî</div>
              <div class="smallline" id="stampLine" aria-live="polite"></div>
            </div>
            <div>
              <h2 id="title">Ten√©s 1 giro disponible</h2>
              <p class="muted" id="subtitle">Los premios se acreditan en tu <b>pr√≥xima carga</b>.</p>
            </div>
          </div>
        </div>

        <div class="panel" style="margin-top:6px">
          <p style="margin-bottom:6px"><b>Resultado actual</b></p>
          <p id="resultLine" class="muted">‚Äî</p>
        </div>

        <!-- Bot√≥n auxiliar para ingresar al juego si se cerr√≥ el modal -->
        <div class="panel" id="auxGamePanel" style="display:none;margin-top:8px">
          <a id="auxGameBtn" class="btn" target="_blank" rel="noopener">üïπÔ∏è Acceder al juego</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Dock -->
<div class="dock">
  <button id="spinBtn" class="btn">üéØ Girar</button>
  <a id="dockPlatform" class="btn alt" target="_blank" rel="noopener">üåê Plataforma</a>
</div>

<script>
/* ===== Plataforma + WhatsApp (4 PCs: ?pc=1|2|3|4) ===== */
const PLATFORM_LINKS = {
  pc1: "https://c01.tu-dominio.com/",  // ‚Üê reemplazar
  pc2: "https://c02.tu-dominio.com/",  // ‚Üê reemplazar
  pc3: "https://c03.tu-dominio.com/",  // ‚Üê reemplazar
  pc4: "https://c04.tu-dominio.com/"   // ‚Üê reemplazar
};
const WP_NUMBERS = {
  pc1: "5491111111111",  // ‚Üê reemplazar
  pc2: "5491122222222",  // ‚Üê reemplazar
  pc3: "5491133333333",  // ‚Üê reemplazar
  pc4: "5491144444444"   // ‚Üê reemplazar
};
/* Enlaces a landings de juegos (pod√©s poner tus URLs reales) */
const GAME_LINKS = {
  "MEMO PLAY": "https://tu-dominio.com/memory", 
  "COFRE MISTERIOSO": "https://tu-dominio.com/cofre",
  "SLOT": "https://tu-dominio.com/slot",
  "30% EXTRA": "https://tu-dominio.com/beneficio30", /* redirige a info o plataforma */
  "RULETA": "https://tu-dominio.com/ruleta",
  "OTRA CHANCE": "" /* sin link; habilita otro tiro */
};

const params = new URLSearchParams(location.search);
const pcParam = (params.get("pc") || "1").trim();
const pcKey = "pc" + (pcParam.match(/^[1-4]$/) ? pcParam : "1");

const PLATFORM = PLATFORM_LINKS[pcKey];
const WP = WP_NUMBERS[pcKey];
document.getElementById("playNow").href = PLATFORM;
document.getElementById("dockPlatform").href = PLATFORM;
document.getElementById("whatsTop").href = `https://wa.me/${WP}`;
document.getElementById("whatsTop").setAttribute("rel","noopener");

/* ===== Antifraude / C√≥digo ===== */
const SALT = "bet300-roulette-v1";
function ensureDeviceId(){
  let id = localStorage.getItem('device_id');
  if(!id){ id = (crypto.randomUUID?.() || `${Date.now()}-${Math.random().toString(36).slice(2,8)}`); localStorage.setItem('device_id', id); }
  return id;
}
const DEVICE_ID = ensureDeviceId();
function todayKey(){const n=new Date();return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`}
function tsString(d=new Date()){
  const dd=String(d.getDate()).padStart(2,'0'),mm=String(d.getMonth()+1).padStart(2,'0'),yyyy=d.getFullYear();
  const hh=String(d.getHours()).padStart(2,'0'),mi=String(d.getMinutes()).padStart(2,'0');
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}
async function sha256hex(msg){
  const enc = new TextEncoder().encode(msg);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function makeClaimCode(prizeLabel){
  const base = `${DEVICE_ID}|${todayKey()}|${prizeLabel}|pc:${pcParam}|${SALT}`;
  const hex = await sha256hex(base);
  return hex.slice(0,10).toUpperCase();
}

/* ===== Sonido ===== */
let soundOn = true;
const soundToggle = document.getElementById('soundToggle');
const soundState  = document.getElementById('soundState');
const AudioKit = (()=>{
  const Ctx = window.AudioContext || window.webkitAudioContext;
  const ctx = new Ctx(); let unlocked=false;
  function unlock(){ if(!unlocked){ ctx.resume().catch(()=>{}); unlocked=true; } }
  function click(freq=900,dur=0.035,vol=0.06){
    const o=ctx.createOscillator(), g=ctx.createGain(); o.type='square'; o.frequency.value=freq; g.gain.value=0; o.connect(g).connect(ctx.destination);
    const t=ctx.currentTime; g.gain.linearRampToValueAtTime(vol, t+0.005); g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
    o.start(t); o.stop(t+dur);
  }
  function spinLoop(){ const id=setInterval(()=>click(780+Math.random()*220,0.028,0.05),80); return ()=>clearInterval(id); }
  function win(){ [660,880,1320].forEach((f,i)=>setTimeout(()=>click(f,0.12,0.09), i*120)); }
  return {ctx,unlock,spinLoop,win};
})();
document.addEventListener('click',()=>AudioKit.unlock(),{once:true});
soundToggle.addEventListener('click',()=>{ soundOn=!soundOn; soundState.textContent=soundOn?'ON':'OFF';});

/* ===== UI ===== */
const spinBtn = document.getElementById('spinBtn');
const badge   = document.getElementById('badge');
const title   = document.getElementById('title');
const subtitle= document.getElementById('subtitle');
const resultLine = document.getElementById('resultLine');
const stampEl = document.getElementById('stampLine');
const mPrize = document.getElementById('mPrize');
const mCode  = document.getElementById('mCode');
const mTs    = document.getElementById('mTs');
const mToGame= document.getElementById('mToGame');
const mToPlatform = document.getElementById('mToPlatform');
const mWhats = document.getElementById('mWhats');
const prizeModal = document.getElementById('prizeModal');
const mClose = document.getElementById('mClose');
const closeModalX = document.getElementById('closeModal');
const auxGamePanel = document.getElementById('auxGamePanel');
const auxGameBtn = document.getElementById('auxGameBtn');

/* ===== Persistencia diaria ===== */
function restoreDaily(){
  const today=todayKey(); const stored=localStorage.getItem('roulette_date');
  if(stored && stored!==today){
    localStorage.removeItem('roulette_done');
    localStorage.removeItem('roulette_prize');
    localStorage.removeItem('roulette_code');
    localStorage.removeItem('roulette_ts');
    localStorage.setItem('roulette_date',today);
  }else if(!stored){ localStorage.setItem('roulette_date',today); }
}
function scheduleMidnightReset(){
  const now=new Date(); const midnight=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,0,0,5,0);
  setTimeout(()=>{localStorage.removeItem('roulette_done');localStorage.removeItem('roulette_prize');localStorage.removeItem('roulette_code');localStorage.removeItem('roulette_ts');localStorage.setItem('roulette_date',todayKey());
    spinBtn.disabled=false; badge.textContent='‚Äî'; title.textContent='Ten√©s 1 giro disponible';
    subtitle.innerHTML='Los premios se acreditan en tu <b>pr√≥xima carga</b>.'; stampEl.textContent=''; resultLine.textContent='‚Äî'; auxGamePanel.style.display='none';
  }, Math.max(1000, midnight.getTime()-now.getTime()));
}

/* ===== Cuenta regresiva ===== */
function endOfDay(){const n=new Date();const end=new Date(n.getFullYear(),n.getMonth(),n.getDate(),23,59,0,0).getTime();
  return end>Date.now()?end:new Date(n.getFullYear(),n.getMonth(),n.getDate()+1,23,59,0,0).getTime()}
function tickCountdown(){
  const ms=endOfDay()-Date.now(); const total=Math.max(0,Math.floor(ms/1000));
  const h=Math.floor(total/3600), m=Math.floor((total%3600)/60), s=total%60;
  document.querySelector('#countdown').textContent=
    h>0?`${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`:`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

/* ===== Ruleta ===== */
const wheel = document.getElementById('wheel');
const wctx = wheel.getContext('2d');
const center = {x: wheel.width/2, y: wheel.height/2};
const radius = Math.min(center.x, center.y) - 12;

/* Segmentos (texto, color, probabilidad) */
const SEGMENTS = [
  {label:"MEMO PLAY",        color:"#ffef9f", p:0.16},
  {label:"COFRE MISTERIOSO", color:"#ffd166", p:0.16},
  {label:"SLOT",             color:"#ffc2a1", p:0.16},
  {label:"30% EXTRA",        color:"#ffa64d", p:0.18},
  {label:"RULETA",           color:"#ff8a1a", p:0.16},
  {label:"OTRA CHANCE",      color:"#ffd9b3", p:0.18}
];
// normalizar (por si edit√°s)
(function normalize(){
  const sum = SEGMENTS.reduce((a,s)=>a+s.p,0);
  SEGMENTS.forEach(s=>s.p = s.p/sum);
})();

let angle=0, spinning=false, targetAngle=0, startTime=0, spinDur=3200;
const winGlow = document.getElementById('winGlow');

function drawWheel(){
  wctx.clearRect(0,0,wheel.width,wheel.height);
  const TAU = Math.PI*2;
  let start = 0;
  SEGMENTS.forEach((seg,i)=>{
    const arc = seg.p*TAU;
    // slice
    wctx.beginPath();
    wctx.moveTo(center.x, center.y);
    wctx.arc(center.x, center.y, radius, start+angle, start+arc+angle);
    wctx.closePath();
    const grad = wctx.createLinearGradient(center.x-radius, center.y-radius, center.x+radius, center.y+radius);
    grad.addColorStop(0, seg.color);
    grad.addColorStop(1, "#ffffff22");
    wctx.fillStyle = grad;
    wctx.fill();
    wctx.lineWidth = 2;
    wctx.strokeStyle = "rgba(255,255,255,.25)";
    wctx.stroke();

    // text
    const mid = start + arc/2 + angle;
    const tx = center.x + Math.cos(mid)*(radius*0.64);
    const ty = center.y + Math.sin(mid)*(radius*0.64);
    wctx.save();
    wctx.translate(tx,ty);
    wctx.rotate(mid+Math.PI/2);
    wctx.fillStyle = "#222";
    wctx.font = "900 16px system-ui,Segoe UI,Roboto";
    wctx.textAlign="center";
    wctx.textBaseline="middle";
    wctx.fillText(seg.label, 0, 0);
    wctx.restore();

    start += arc;
  });

  // centro
  wctx.beginPath();
  wctx.arc(center.x, center.y, 40, 0, TAU);
  const cg = wctx.createRadialGradient(center.x,center.y,8, center.x,center.y,40);
  cg.addColorStop(0,"#fff");
  cg.addColorStop(1,"#ffe3ba");
  wctx.fillStyle = cg; wctx.fill();
  wctx.lineWidth=3; wctx.strokeStyle="#ffb56b"; wctx.stroke();

  // texto centro
  wctx.fillStyle="#8a4300";
  wctx.font="900 14px system-ui,Segoe UI,Roboto";
  wctx.textAlign="center"; wctx.textBaseline="middle";
  wctx.fillText("GIRAR", center.x, center.y);
}

function animate(){
  drawWheel();
  requestAnimationFrame(animate);
}
animate();

function spin(){
  if(spinning) return;
  if(localStorage.getItem('roulette_done')==='1'){ alert("Ya usaste tu giro de hoy"); return; }
  spinning=true; spinBtn.disabled=true;
  auxGamePanel.style.display='none';

  let stopLoop=null; if(soundOn) stopLoop = AudioKit.spinLoop();

  // elegir segmento por probabilidad
  const r = Math.random();
  let acc=0, index=0;
  for(let i=0;i<SEGMENTS.length;i++){ acc+=SEGMENTS[i].p; if(r<=acc){ index=i; break; } }

  // convertir a √°ngulo objetivo (el puntero est√° arriba; queremos que el centro del segmento quede ah√≠)
  const TAU = Math.PI*2;
  let start=0;
  for(let i=0;i<index;i++) start += SEGMENTS[i].p*TAU;
  const arc = SEGMENTS[index].p*TAU;
  const segMid = start + arc/2;
  const spins = 4 + Math.floor(Math.random()*2); // 4-5 vueltas
  targetAngle = (TAU*spins) - segMid; // que el mid caiga en el puntero (0 rad)
  startTime = performance.now();
  const dur = spinDur + Math.random()*600;

  (function step(now){
    const k = Math.min(1,(now-startTime)/dur);
    const ease = 1 - Math.pow(1-k, 3);
    angle = ease*targetAngle;
    if(k<1){ requestAnimationFrame(step); }
    else{
      if(stopLoop) stopLoop();
      onStop(index);
    }
  })(startTime);
}

spinBtn.addEventListener('click', spin);

/* ===== Premio ===== */
function openModal(prizeLabel, code, ts, gameUrl){
  mPrize.textContent = prizeLabel;
  mCode.textContent  = code;
  mTs.textContent    = ts;

  mToPlatform.href = PLATFORM;
  mToPlatform.target = "_blank";
  mToPlatform.rel = "noopener";

  mWhats.href = `https://wa.me/${WP}`;
  mWhats.target = "_blank";
  mWhats.rel = "noopener";

  if(gameUrl){
    mToGame.style.display='';
    mToGame.href = gameUrl;
    mToGame.target = "_blank";
    mToGame.rel = "noopener";
  }else{
    mToGame.style.display='none';
  }

  prizeModal.classList.add('show');
}
function closeModal(){ prizeModal.classList.remove('show'); }
mClose.onclick = closeModal; closeModalX.onclick = closeModal;
prizeModal.addEventListener('click',e=>{ if(e.target===prizeModal) closeModal(); });

/* ===== Confetti simple ===== */
function confettiBurst(){
  const el=document.getElementById('confetti'); el.innerHTML='';
  const n=28;
  for(let i=0;i<n;i++){
    const p=document.createElement('i');
    p.style.left=(Math.random()*100)+'vw';
    p.style.animationDelay=(Math.random()*0.5)+'s';
    p.style.background = Math.random()<.5?'linear-gradient(#fff1a8,#ff8a1a)':'linear-gradient(#c8f7ff,#00d1ff)';
    el.appendChild(p);
  }
  setTimeout(()=>{el.innerHTML='';},1800);
}

/* ===== Glow ganador ===== */
function flashGlow(){
  winGlow.style.boxShadow = "0 0 0 6px rgba(255,255,255,.18), 0 0 40px 10px rgba(255,255,255,.35), inset 0 0 40px rgba(255,255,255,.15)";
  setTimeout(()=>{ winGlow.style.boxShadow = "0 0 0 0 rgba(255,255,255,0)"; }, 1100);
}

/* ===== Resultado ===== */
async function onStop(index){
  const seg = SEGMENTS[index];
  const label = seg.label;
  const prizeLabel = label; // texto directo
  const code = await makeClaimCode(prizeLabel);
  const ts   = tsString(new Date());
  const gameUrl = GAME_LINKS[label] || "";

  // guardar / marcar fin del d√≠a
  localStorage.setItem('roulette_code', code);
  localStorage.setItem('roulette_ts', ts);
  localStorage.setItem('roulette_prize', JSON.stringify({label, url:gameUrl}));
  localStorage.setItem('roulette_done','1');

  badge.textContent = label;
  title.textContent = "üéâ ¬°Premio obtenido!";
  subtitle.innerHTML = `Aplicable a tu <b>pr√≥xima carga</b>.`;
  stampEl.textContent = `C√≥digo: ${code} ¬∑ ${ts}`;

  resultLine.textContent = `Resultado: ${label}`;
  flashGlow();
  confettiBurst();
  if(soundOn) AudioKit.win();

  // mostrar modal
  openModal(prizeLabel, code, ts, gameUrl);

  // si hay link de juego, habilitar bot√≥n auxiliar por si cierran modal
  if(gameUrl){
    auxGameBtn.href = gameUrl;
    auxGamePanel.style.display = '';
  }else{
    auxGamePanel.style.display = 'none';
  }

  // si fue "OTRA CHANCE", permitir un tiro extra (una sola vez)
  if(label === "OTRA CHANCE"){
    localStorage.removeItem('roulette_done'); // habilita otro
    title.textContent = "üéØ ¬°Otra chance habilitada!";
    subtitle.innerHTML = `Prob√° suerte nuevamente ahora mismo.`;
    spinBtn.disabled = false;
  }
}

/* ===== Init ===== */
function init(){
  restoreDaily(); tickCountdown(); setInterval(tickCountdown,1000); scheduleMidnightReset();
  // Top botones ya apuntan a PLATFORM/WA
}
init();
</script>
</body>
</html>
