<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>BET300 ¬∑ Selector Arcade</title>
<meta name="theme-color" content="#0b1120"/>
<style>
  :root{
    --bg:#0b1120; --panel:#0f172a; --panel2:#0b1326; --border:#1e2a4a;
    --text:#e8ecff; --muted:#9aa3c7; --accent:#49b6ff; --gold:#e8c25e; --ok:#25d366;
    --neon1:#7c59ff; --neon2:#22d3ee; --tile:#121c3a; --tile2:#0e1630;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:980px;margin:18px auto 88px;padding:0 14px}
  .head{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:8px}
  .brandBox{display:flex;align-items:center;gap:10px}
  .logo{height:48px;display:block}
  .brandText{font-weight:900;letter-spacing:.6px;font-size:28px;
    background:linear-gradient(180deg,#fff,#f6e6b0 65%,#caa94b);
    -webkit-background-clip:text;background-clip:text;color:transparent}
  .pill{margin-left:auto;background:rgba(73,182,255,.12);border:1px solid var(--border);
    border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:14px;box-shadow:0 20px 50px rgba(0,0,0,.35)}

  .grid{display:grid;gap:12px}
  @media(min-width:900px){.grid{grid-template-columns:1.05fr .95fr}}

  /* STAGE */
  .stage{background:
    radial-gradient(80% 120% at 50% 0%,rgba(124,89,255,.12),transparent),
    radial-gradient(60% 100% at 0% 100%,rgba(34,211,238,.10),transparent),
    var(--panel2);
    border:1px solid var(--border);border-radius:16px;padding:14px}
  .hint{color:var(--muted);font-size:12px;text-align:center;margin-top:8px}

  /* PRIZE GRID */
  .grid4{display:grid;grid-template-columns:1fr 1fr;gap:12px;max-width:560px;margin:6px auto}
  .tile{
    position:relative;overflow:hidden;border-radius:16px;padding:16px;text-align:center;
    background:linear-gradient(180deg,var(--tile),var(--tile2));
    border:1px solid #263156; box-shadow:inset 0 0 0 1px rgba(255,255,255,.04),0 12px 36px rgba(0,0,0,.45);
    min-height:118px; display:grid; place-items:center;
  }
  .tile h2{margin:0;font-size:20px;letter-spacing:.5px}
  .tile p{margin:6px 0 0;color:var(--muted);font-size:12px}
  .tile .icon{font-size:30px;margin-bottom:4px;opacity:.95}
  .tile:before{
    content:""; position:absolute; inset:-2px; border-radius:18px; pointer-events:none;
    box-shadow:0 0 0 0 rgba(124,89,255,.0), 0 0 0 0 rgba(34,211,238,.0); transition:box-shadow .2s;
  }
  .tile.active:before{
    box-shadow:0 0 12px 2px rgba(124,89,255,.55), 0 0 22px 6px rgba(34,211,238,.35);
  }
  .tile.win{outline:2px solid rgba(255,210,96,.65);}

  /* BUTTONS */
  .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px}
  .btn{appearance:none;border:none;cursor:pointer;padding:13px 16px;border-radius:14px;font-weight:800}
  .btn.primary{background:linear-gradient(90deg,#ffd48a,#e9b84f);color:#09121f;box-shadow:0 10px 24px rgba(233,184,79,.25)}
  .btn.secondary{background:#1fbf61;color:#07131e;border:1px solid rgba(255,255,255,.08);box-shadow:0 8px 20px rgba(31,191,97,.25)}
  .btn.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
  .btn.full{width:100%}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  /* SIDE PANEL */
  .side{background:var(--panel2);border:1px solid var(--border);border-radius:16px;padding:12px}
  .side h3{margin:0 0 8px}
  .row{display:flex;justify-content:space-between;align-items:center;margin:6px 0;padding:8px;border:1px dashed var(--border);border-radius:12px}
  .k{color:var(--muted);font-size:13px}
  .v{font-weight:800}
  .small{font-size:12px;color:var(--muted)}

  /* CONFETTI */
  .confetti{position:fixed;inset:0;pointer-events:none;z-index:40}
  .confetti i{position:absolute;top:-20px;width:10px;height:14px;border-radius:2px;opacity:0;animation:confFall 1.6s linear forwards}
  @keyframes confFall{8%{opacity:1}100%{transform:translateY(110vh) rotate(360deg);opacity:0}}

  /* MODAL */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(4,6,14,.6);backdrop-filter:blur(4px);z-index:60}
  .modal.show{display:flex}
  .modalCard{width:min(520px,92vw);background:var(--panel2);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 20px 50px rgba(0,0,0,.45)}
  .modalHead{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .modalHead h3{margin:0;font-size:18px}
  .closeX{margin-left:auto;cursor:pointer;opacity:.8}
  .closeX:hover{opacity:1}

  /* DOCK */
  .dock{position:fixed;left:0;right:0;bottom:0;z-index:20;background:linear-gradient(180deg, rgba(11,15,30,0) 0%, rgba(11,15,30,.85) 22%, rgba(11,15,30,.95) 100%);
    padding:8px 10px 10px;display:flex;gap:8px}
  @media(max-width:420px){
    .tile{min-height:108px}
    .tile h2{font-size:18px}
    .logo{height:42px}
  }
</style>
</head>
<body>
<div id="confetti" class="confetti" aria-hidden="true"></div>

<!-- MODAL -->
<div id="prizeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modalCard">
    <div class="modalHead">
      <h3 id="modalTitle">üéÅ Beneficio obtenido</h3>
      <span id="closeModal" class="closeX">‚úñ</span>
    </div>
    <div class="modalBody">
      <div class="row"><span class="k">Promo</span><span class="v" id="mPrize">‚Äî</span></div>
      <div class="row"><span class="k">C√≥digo</span><span class="v" id="mCode">‚Äî</span></div>
      <div class="row"><span class="k">Fecha/Hora</span><span class="v" id="mTs">‚Äî</span></div>
      <div class="actions">
        <button id="mToGame" class="btn ghost">Ir al detalle</button>
        <button id="mToPlatform" class="btn secondary">Ingresar a la plataforma</button>
        <button id="mClaim" class="btn primary">üì≤ Reclamar por WhatsApp</button>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="head">
    <div class="brandBox">
      <img class="logo" src="bet300-logo.png" alt="BET300"
           onerror="this.remove();document.getElementById('brandText').style.display='block'">
      <div id="brandText" class="brandText" style="display:none">BET300</div>
    </div>
    <span class="pill">Autogesti√≥n habilitada</span>
  </div>

  <div class="card">
    <div class="grid">
      <div class="stage">
        <div class="grid4" id="grid">
          <!-- Se construyen por JS para rotar posiciones -->
        </div>
        <div class="actions">
          <button id="btnPlay" class="btn primary">üéØ Jugar</button>
        </div>
        <div class="hint">Ten√©s 1 intento por d√≠a. El beneficio se acredita con tu pr√≥xima carga (m√≠nima).</div>
      </div>

      <div class="side">
        <h3>üìå Detalles</h3>
        <div class="row"><span class="k">Estado</span><span class="v" id="st">Listo para jugar</span></div>
        <div class="row"><span class="k">Resultado</span><span class="v" id="res">‚Äî</span></div>
        <div class="row"><span class="k">Cuenta regresiva</span><span class="v" id="count">‚Äî</span></div>
        <div class="actions">
          <button id="btnPlatform" class="btn secondary">Ingresar a la plataforma</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Dock -->
<div class="dock">
  <button id="btnClaim" class="btn primary full" disabled>üì≤ Reclamar</button>
</div>

<script>
/* ========= Par√°metros por PC ========= */
const params = new URLSearchParams(location.search);
const pc = params.get('pc') || '1';
const pcKey = ['1','2','3','4'].includes(pc) ? pc : '1';

const WHATS = {
  '1': '5491171561685',
  '2': '5491171561022',
  '3': '5491171331067',
  '4': '5491135854862'
};
const PLATFORM = {
  '1': 'https://bet300.site/html/primer-ingreso',
  '2': 'https://bet300.site/html/primer-ingreso',
  '3': 'https://bet300.site/html/primer-ingreso',
  '4': 'https://bet300.site/html/primer-ingreso'
};
const GAME_LINKS = {
  ruleta:  {'1':'https://ruleta-bet300.vercel.app/?pc=1','2':'https://ruleta-bet300.vercel.app/?pc=2','3':'https://ruleta-bet300.vercel.app/?pc=3','4':'https://ruleta-bet300.vercel.app/?pc=4'},
  slot:    {'1':'https://slot-bet300-ch.vercel.app/?pc=1','2':'https://slot-bet300-ch.vercel.app/?pc=2','3':'https://slot-bet300-ch.vercel.app/?pc=3','4':'https://slot-bet300-ch.vercel.app/?pc=4'},
  cofre:   {'1':'https://mistery-box-one.vercel.app/?pc=1','2':'https://mistery-box-one.vercel.app/?pc=2','3':'https://mistery-box-one.vercel.app/?pc=3','4':'https://mistery-box-one.vercel.app/?pc=4'},
  memoplay:{'1':'https://bet300-memoplay.vercel.app/?pc=1','2':'https://bet300-memoplay.vercel.app/?pc=2','3':'https://bet300-memoplay.vercel.app/?pc=3','4':'https://bet300-memoplay.vercel.app/?pc=4'}
};

/* ========= Utilidades ========= */
const SALT = "bet300-arcade-v1";
function ensureDeviceId(){
  let id = localStorage.getItem('arcade_device');
  if(!id){ id = (crypto.randomUUID?.() || `${Date.now()}-${Math.random().toString(36).slice(2,8)}`); localStorage.setItem('arcade_device', id); }
  return id;
}
const DEVICE_ID = ensureDeviceId();
function todayKey(){const n=new Date();return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`}
function tsString(d=new Date()){
  const dd=String(d.getDate()).padStart(2,'0'),mm=String(d.getMonth()+1).padStart(2,'0'),yyyy=d.getFullYear();
  const hh=String(d.getHours()).padStart(2,'0'),mi=String(d.getMinutes()).padStart(2,'0');
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}
async function sha256hex(msg){
  const enc = new TextEncoder().encode(msg);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function makeCode(label){
  const base = `${DEVICE_ID}|${todayKey()}|${label}|pc:${pc}|${SALT}`;
  const hex = await sha256hex(base);
  return hex.slice(0,10).toUpperCase();
}
function confetti(){
  const el=document.getElementById('confetti'); el.innerHTML='';
  const n=30; for(let i=0;i<n;i++){
    const p=document.createElement('i');
    p.style.left=(Math.random()*100)+'vw';
    p.style.animationDelay=(Math.random()*0.5)+'s';
    p.style.background = Math.random()<.5?'linear-gradient(#80ffea,#4e9cff)':'linear-gradient(#ffd166,#ff3d7f)';
    el.appendChild(p);
  } setTimeout(()=>{el.innerHTML='';},1700);
}

/* ========= UI refs ========= */
const gridEl = document.getElementById('grid');
const btnPlay = document.getElementById('btnPlay');
const btnPlatform = document.getElementById('btnPlatform');
const btnClaim = document.getElementById('btnClaim');
const st = document.getElementById('st');
const res = document.getElementById('res');
const count = document.getElementById('count');

/* Modal */
const prizeModal = document.getElementById('prizeModal');
const mPrize = document.getElementById('mPrize');
const mCode  = document.getElementById('mCode');
const mTs    = document.getElementById('mTs');
const mToGame = document.getElementById('mToGame');
const mToPlatform = document.getElementById('mToPlatform');
const mClaim = document.getElementById('mClaim');
const closeModalX = document.getElementById('closeModal');
function openModal(){ prizeModal.classList.add('show'); }
function closeModal(){ prizeModal.classList.remove('show'); }
closeModalX.onclick = closeModal;
prizeModal.addEventListener('click',e=>{ if(e.target===prizeModal) closeModal(); });

/* ========= Data de premios ========= */
const PRIZES = [
  {key:'ruleta',  label:'Tirada en Ruleta',  icon:'üéØ'},
  {key:'slot',    label:'Giro en Slot',      icon:'üé∞'},
  {key:'cofre',   label:'Cofre Misterioso',  icon:'üóùÔ∏è'},
  {key:'memoplay',label:'Intento en Memoplay',icon:'üß†'}
];

/* Construir grilla (con posiciones aleatorias cada carga) */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
let layout = shuffle([...PRIZES]); // reordenado
function renderGrid(){
  gridEl.innerHTML = layout.map(p=>`
    <div class="tile" data-key="${p.key}">
      <div class="icon">${p.icon}</div>
      <div>
        <h2>${p.label.split(' ')[0]}</h2>
        <p>${p.label.includes('Cofre')?'Misterioso':p.label.replace(/^[^ ]+ /,'')}</p>
      </div>
    </div>
  `).join('');
}
renderGrid();

/* Barrido de ne√≥n y selecci√≥n */
let playing=false;
btnPlay.onclick = async ()=>{
  if(playing) return;
  if(localStorage.getItem('arcade_done')==='1'){ alert('Ya usaste tu intento de hoy.'); return; }
  playing=true; st.textContent='Seleccionando‚Ä¶'; btnPlay.disabled=true; btnClaim.disabled=true;

  const tiles = [...document.querySelectorAll('.tile')];
  let idx = 0;
  let cycles = 2 + Math.floor(Math.random()*2); // 2‚Äì3 vueltas completas
  const target = Math.floor(Math.random()*tiles.length);

  function setActive(i){
    tiles.forEach(t=>t.classList.remove('active'));
    tiles[i].classList.add('active');
  }

  let steps = cycles*tiles.length + target;
  const base = 90; // ms
  function step(){
    setActive(idx % tiles.length);
    idx++;
    steps--;
    const remain = steps;
    const speed = base + (Math.max(0, (tiles.length*2 - remain))*22); // desacelera
    if(steps>=0) setTimeout(step, speed);
    else finish((idx-1)%tiles.length);
  }
  step();

  async function finish(winIndex){
    const tiles2 = [...document.querySelectorAll('.tile')];
    tiles2.forEach(t=>t.classList.remove('active','win'));
    const winner = tiles2[winIndex];
    winner.classList.add('win');
    const key = winner.getAttribute('data-key');
    const prize = PRIZES.find(p=>p.key===key);

    const code = await makeCode(prize.key.toUpperCase());
    const ts = tsString(new Date());

    localStorage.setItem('arcade_date', todayKey());
    localStorage.setItem('arcade_done','1');
    localStorage.setItem('arcade_result', JSON.stringify({key:prize.key,label:prize.label,ts,code,pc}));

    res.textContent = prize.label;
    st.textContent  = '¬°Ganaste!';
    btnClaim.disabled = false;

    mPrize.textContent = prize.label;
    mCode.textContent  = code;
    mTs.textContent    = ts;

    mToGame.onclick = ()=>{
      const url = GAME_LINKS[prize.key]?.[pcKey] || PLATFORM[pcKey];
      location.href = url;
    };
    mToPlatform.onclick = ()=> location.href = PLATFORM[pcKey];

    const msg = `Hola, gan√©: ${encodeURIComponent(prize.label)} en BET300. C√≥digo: ${code} ¬∑ ${ts}`;
    const wa  = `https://wa.me/${WHATS[pcKey]}?text=${msg}`;
    mClaim.onclick = ()=> location.href = wa;
    btnClaim.onclick = ()=> location.href = wa;

    openModal(); confetti();
    playing=false;
  }
};

/* 1 intento por d√≠a + countdown */
function restoreDaily(){
  const today=todayKey(); const stored=localStorage.getItem('arcade_date');
  if(stored && stored!==today){
    localStorage.removeItem('arcade_done'); localStorage.removeItem('arcade_result');
    localStorage.setItem('arcade_date',today);
  } else if(!stored){ localStorage.setItem('arcade_date',today); }
}
function restoreResult(){
  const done=localStorage.getItem('arcade_done')==='1'; const saved=localStorage.getItem('arcade_result');
  if(done && saved){
    const r=JSON.parse(saved);
    res.textContent=r.label||'‚Äî';
    st.textContent='Premio obtenido';
    btnPlay.disabled=true; btnClaim.disabled=false;
    const msg = `Hola, gan√©: ${encodeURIComponent(r.label)} en BET300. C√≥digo: ${r.code} ¬∑ ${r.ts}`;
    const wa  = `https://wa.me/${WHATS[pcKey]}?text=${msg}`;
    btnClaim.onclick=()=>location.href=wa;
  }
}
function endOfDay(){const n=new Date();const end=new Date(n.getFullYear(),n.getMonth(),n.getDate(),23,59,0,0).getTime();
  return end>Date.now()?end:new Date(n.getFullYear(),n.getMonth(),n.getDate()+1,23,59,0,0).getTime()}
function tickCountdown(){
  const ms=endOfDay()-Date.now(); const total=Math.max(0,Math.floor(ms/1000));
  const h=Math.floor(total/3600), m=Math.floor((total%3600)/60), s=total%60;
  count.textContent=h>0?`${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`:`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
setInterval(tickCountdown,1000);

/* Botones extra */
btnPlatform.onclick = ()=> location.href = PLATFORM[pcKey];

/* Init */
function init(){
  restoreDaily(); restoreResult(); tickCountdown();
}
init();
</script>
</body>
</html>
