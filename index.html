<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>BET300 ¬∑ Cartas de beneficios</title>
<meta name="theme-color" content="#0a0f1f"/>
<style>
:root{
  --bg1:#0b0f25;           /* azul noche */
  --bg2:#1a0f3a;           /* violeta profundo */
  --panel:#0f1429;
  --panel2:#0b1026;
  --border:#1a2250;
  --text:#e9ecff;
  --muted:#aab0d6;
  --ok:#25D366;
  --accent:#7c4dff;
  --cyan:#22d3ee;
  --gold:#ffd166;
  --danger:#ff5c39;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--text);font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto;
  background: radial-gradient(1200px 700px at 75% -10%, rgba(124,77,255,.25), transparent 60%),
              radial-gradient(900px 500px at 0% 0%, rgba(0,209,255,.18), transparent 60%),
              linear-gradient(180deg,var(--bg2) 0%, var(--bg1) 60%, #0a0f1f 100%);
}

/* Layout */
.container{max-width:1050px;margin:8px auto 92px;padding:0 12px}
.card{background:linear-gradient(180deg, rgba(124,77,255,.10), rgba(34,211,238,.06)), var(--panel2); border:1px solid var(--border);
  border-radius:18px;padding:10px;box-shadow:0 15px 40px rgba(0,0,0,.35)}
@media(min-width:920px){.grid{display:grid;grid-template-columns:1.05fr .95fr;gap:10px}}
@media(max-width:560px){.card{border-radius:12px}}

.head{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:6px}
.brand{display:flex;align-items:center;gap:8px}
.brand .logo{width:34px;height:34px;border-radius:9px;display:grid;place-items:center;
  background:linear-gradient(135deg,#2e6bff,#7c59ff);font-weight:900}
.brand .name{font-weight:900;letter-spacing:.5px;font-size:22px}
.pill{background:linear-gradient(90deg,rgba(124,77,255,.13),rgba(0,209,255,.13));border:1px solid var(--border);
  border-radius:999px;padding:6px 8px;font-size:12px;color:var(--muted)}
.pill.time{display:flex;gap:6px;align-items:center}
.pill.sound{cursor:pointer;user-select:none}
.count{display:inline-flex;gap:6px;align-items:center;padding:3px 8px;border-radius:999px;background:rgba(255,204,0,.15);
  border:1px solid rgba(255,204,0,.35);color:#ffe27a;font-weight:700;font-variant-numeric:tabular-nums}
.rightTop{margin-left:auto;display:flex;gap:8px;align-items:center}
.btnLink{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:12px;font-weight:800;
  background:linear-gradient(90deg,#7c59ff,#00d1ff);color:#0a0f1f;text-decoration:none;border:1px solid rgba(255,255,255,.06)}
.btnLink.green{background:linear-gradient(90deg,#22c55e,#72ff9a)}

/* Panel derecho */
.panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px}
.center{text-align:left}
.stat{display:flex;gap:12px;align-items:center;margin:6px 0 8px}
.badge{min-width:78px;height:42px;border-radius:10px;background:radial-gradient(100% 100% at 50% 0%, rgba(0,209,255,.35), rgba(124,77,255,.35));
  display:grid;place-items:center;font-weight:800;font-size:18px;box-shadow:inset 0 0 10px rgba(124,77,255,.35)}
.smallline{font-size:12px;color:var(--muted)}
.muted{color:var(--muted)}

/* Cartas */
.deck{
  display:grid;grid-template-columns:repeat(3,1fr);gap:10px;min-height:260px;
  align-content:start;justify-items:center;padding:6px;
}
@media(max-width:560px){
  .deck{grid-template-columns:repeat(3,1fr);gap:8px}
}
.cardItem{
  width:125px;height:165px; perspective: 800px;
}
.cardInner{
  position:relative;width:100%;height:100%;transform-style:preserve-3d;transition:transform .6s cubic-bezier(.2,.8,.2,1);
  border-radius:14px;
}
.cardInner.flip{transform:rotateY(180deg)}
.cardFace{
  position:absolute;inset:0;border-radius:14px;display:flex;flex-direction:column;align-items:center;justify-content:center;
  backface-visibility:hidden;border:1px solid #2a2f58;overflow:hidden;
}

/* Dorso gaming con ne√≥n */
.back{
  background: radial-gradient(120% 100% at 50% 0%, rgba(124,77,255,.15), transparent 70%), #0c112a;
  display:grid;place-items:center;
}
.back .bet{
  font-weight:900;font-size:28px;letter-spacing:1px;color:#b8ccff;
  text-shadow:
    0 0 6px #7aa7ff,
    0 0 12px #5fb7ff,
    0 0 22px #49f3ff,
    0 0 36px rgba(73,243,255,.35);
}

/* Frente */
.front{
  transform:rotateY(180deg);
  background:linear-gradient(180deg, rgba(124,77,255,.15), rgba(34,211,238,.10));
}
.front h4{margin:0 8px 6px;font-size:16px}
.front p{margin:0 10px;font-size:12px;color:var(--muted);text-align:center}

/* Colores por tipo (contraste alto sobre fondo) */
.front.co-30   { background:linear-gradient(180deg,#ffb770,#ff7b3d) }
.front.ruleta  { background:linear-gradient(180deg,#a78bfa,#7c3aed) }
.front.slot    { background:linear-gradient(180deg,#60a5fa,#2563eb) }
.front.memo    { background:linear-gradient(180deg,#34d399,#059669) }
.front.cofre   { background:linear-gradient(180deg,#facc15,#f59e0b) }
.front.otra    { background:linear-gradient(180deg,#9ca3af,#6b7280) }

/* Selecci√≥n */
.cardInner.winner{box-shadow:0 0 0 3px rgba(124,77,255,.7), 0 0 24px rgba(124,77,255,.35)}
.cardInner.loser {opacity:.66;}

/* Dock inferior */
.dock{
  position:fixed;left:0;right:0;bottom:0;z-index:20;
  background:linear-gradient(180deg, rgba(11,15,30,0) 0%, rgba(11,15,30,.85) 22%, rgba(11,15,30,.95) 100%);
  padding:8px 10px 10px;display:flex;gap:8px;flex-wrap:wrap;
}
.btn{
  appearance:none;border:none;cursor:pointer;padding:12px 14px;border-radius:14px;font-weight:800;
  background:linear-gradient(90deg,#ff9a3d,#ff5c39);color:#0b0f1e;box-shadow:0 8px 20px rgba(0,0,0,.35)
}
.btn:disabled{opacity:.6;cursor:not-allowed}
.btn.ok{background:#25D366;color:#0b0f1e}
.btn.alt{background:linear-gradient(90deg,#22c55e,#72ff9a)}
.btn.ghost{background:transparent;color:var(--text);border:1px solid var(--border)}

/* Confetti */
.confetti{position:fixed;inset:0;pointer-events:none;z-index:40}
.confetti i{position:absolute;top:-20px;width:10px;height:14px;border-radius:2px;opacity:0;animation:confFall 1.6s linear forwards}
@keyframes confFall{8%{opacity:1}100%{transform:translateY(110vh) rotate(360deg);opacity:0}}

/* Modal premio */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(4,6,14,.6);backdrop-filter:blur(4px);z-index:60}
.modal.show{display:flex}
.modalCard{width:min(520px,92vw);background:var(--panel2);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 20px 50px rgba(0,0,0,.45)}
.modalHead{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.modalHead h3{margin:0;font-size:18px}
.modalBody{display:grid;gap:8px}
.row{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px dashed var(--border);border-radius:12px;padding:10px}
.k{color:var(--muted);font-size:13px}.v{font-weight:800}
.actions{display:flex;gap:8px;margin-top:8px}

/* compact m√≥vil */
@media(max-width:420px){
  .badge{min-width:70px;height:38px;font-size:16px}
  .cardItem{width:110px;height:150px}
  .front h4{font-size:14px}
}
</style>
</head>
<body>

<div id="confetti" class="confetti" aria-hidden="true"></div>

<!-- MODAL PREMIO -->
<div id="prizeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modalCard">
    <div class="modalHead">
      <h3 id="modalTitle">üéÅ Beneficio obtenido</h3>
      <span id="closeModal" class="btn ghost" style="margin-left:auto">Cerrar</span>
    </div>
    <div class="modalBody">
      <div class="row"><span class="k">Premio</span><span class="v" id="mPrize">‚Äî</span></div>
      <div class="row"><span class="k">C√≥digo</span><span class="v" id="mCode">‚Äî</span></div>
      <div class="row"><span class="k">Fecha/Hora</span><span class="v" id="mTs">‚Äî</span></div>
      <div id="mHint" class="smallline"></div>
      <div class="actions">
        <a id="mGame" class="btn alt" target="_blank" rel="noopener" style="display:none">Ir al juego</a>
        <a id="mWp" class="btn ok" target="_blank" rel="noopener" style="display:none">Pedir por WhatsApp</a>
        <a id="mPlatform" class="btn alt" target="_blank" rel="noopener">Plataforma</a>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="card">
    <div class="head">
      <div class="brand"><div class="logo">B3</div><div class="name">BET300</div></div>
      <span class="pill">Cartas de beneficios</span>
      <span class="pill time">‚ö° Tiempo limitado <span class="count" id="countdown">--:--</span></span>
      <span class="pill sound" id="soundToggle">üîä Sonido: <b id="soundState">ON</b></span>
      <div class="rightTop">
        <a id="playNow" class="btnLink" target="_blank" rel="noopener">üéÆ Plataforma</a>
        <a id="wpQuick" class="btnLink green" target="_blank" rel="noopener" style="display:none">üü¢ WhatsApp</a>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <h2 style="margin:0 0 8px">Eleg√≠ una carta y descubr√≠ tu beneficio</h2>
        <div id="deck" class="deck"></div>
        <div class="smallline" id="hint" style="padding:6px 8px">Tip: mejor visual en vertical üì±</div>
      </div>

      <div class="panel">
        <div class="center">
          <div class="stat">
            <div>
              <div class="badge" id="badge">-</div>
              <div class="smallline" id="stampLine" aria-live="polite"></div>
            </div>
            <div>
              <h2 id="title">Ten√©s 1 intento disponible</h2>
              <p class="muted" id="subtitle">Los beneficios se aplican a tu <b>pr√≥xima carga</b>.</p>
            </div>
          </div>
        </div>

        <div class="panel" style="margin-top:6px">
          <p style="margin-bottom:6px"><b>Resultado actual</b></p>
          <p id="resultLine" class="muted">‚Äî</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Dock -->
<div class="dock">
  <button id="retryBtn" class="btn ghost" style="flex:1 1 220px;display:none">üîÅ Reintentar (si sale ‚ÄúOtra chance‚Äù)</button>
  <a id="quickGameBtn" class="btn alt" style="flex:1 1 220px;display:none" target="_blank" rel="noopener">üéÆ Abrir juego</a>
  <a id="platformBtn" class="btn alt" style="flex:2 1 260px" target="_blank" rel="noopener">üåê Plataforma</a>
</div>

<script>
/* ===== Plataforma + WhatsApp por PC ===== */
const PLATFORM_LINKS = {
  pc1: "https://plataforma1.example.com/",
  pc2: "https://plataforma2.example.com/",
  pc3: "https://plataforma3.example.com/",
  pc4: "https://plataforma4.example.com/"
};
const GAME_LINKS = {          // reemplaz√° por tus landings reales
  "30% EXTRA": null,          // se pide por WhatsApp
  "RULETA": "https://promo.example.com/ruleta",
  "SLOT": "https://promo.example.com/slot",
  "MEMO PLAY": "https://promo.example.com/memory",
  "COFRE MISTERIOSO": "https://promo.example.com/cofre",
  "OTRA CHANCE": null
};
const WP_NUMBERS = {
  pc1: "5491131583516",
  pc2: "5491126695257",
  pc3: "5491125368306",
  pc4: "5491150030414"
};
const params = new URLSearchParams(location.search);
const pc = (params.get('pc')||"1").trim();
const pcKey = "pc"+(pc.match(/^[1-4]$/)?pc:"1");
const PLATFORM = PLATFORM_LINKS[pcKey];
const WP = WP_NUMBERS[pcKey];
document.getElementById('playNow').href = PLATFORM;
document.getElementById('platformBtn').href = PLATFORM;
document.getElementById('mPlatform').href = PLATFORM;

/* ===== Antifraude / utilidades ===== */
const SALT = "bet300-cards-v2";
function ensureDeviceId(){
  let id = localStorage.getItem('device_id');
  if(!id){
    id = (crypto.randomUUID?.() || `${Date.now()}-${Math.random().toString(36).slice(2,8)}`);
    localStorage.setItem('device_id', id);
  }
  return id;
}
const DEVICE_ID = ensureDeviceId();
function todayKey(){const n=new Date();return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`}
function tsString(d=new Date()){
  const dd=String(d.getDate()).padStart(2,'0'),mm=String(d.getMonth()+1).padStart(2,'0'),yyyy=d.getFullYear();
  const hh=String(d.getHours()).padStart(2,'0'),mi=String(d.getMinutes()).padStart(2,'0');
  return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
}
async function sha256hex(msg){
  const enc = new TextEncoder().encode(msg);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function makeClaimCode(prizeLabel){
  const base = `${DEVICE_ID}|${todayKey()}|${prizeLabel}|pc:${pc}|${SALT}`;
  const hex = await sha256hex(base);
  return hex.slice(0,10).toUpperCase();
}
function money(n){ return "$"+n.toLocaleString("es-AR"); }

/* ===== Sonido m√≠nimo ===== */
let soundOn = true;
const soundToggle = document.getElementById('soundToggle');
const soundState  = document.getElementById('soundState');
const AudioKit = (()=>{
  const Ctx = window.AudioContext || window.webkitAudioContext;
  const ctx = new Ctx(); let unlocked=false;
  function unlock(){ if(!unlocked){ ctx.resume().catch(()=>{}); unlocked=true; } }
  function click(freq=900,dur=0.055,vol=0.07){
    const o=ctx.createOscillator(), g=ctx.createGain(); o.type='triangle'; o.frequency.value=freq; g.gain.value=0; o.connect(g).connect(ctx.destination);
    const t=ctx.currentTime; g.gain.linearRampToValueAtTime(vol, t+0.006); g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
    o.start(t); o.stop(t+dur);
  }
  function win(){ [660,880,1320].forEach((f,i)=>setTimeout(()=>click(f,0.12,0.09), i*120)); }
  return {ctx,unlock,click,win};
})();
document.addEventListener('click',()=>AudioKit.unlock(),{once:true});
soundToggle.addEventListener('click',()=>{ soundOn=!soundOn; soundState.textContent=soundOn?'ON':'OFF';});

/* ===== Confetti ===== */
function confettiBurst(){
  const el=document.getElementById('confetti'); el.innerHTML='';
  const n=28;
  for(let i=0;i<n;i++){
    const p=document.createElement('i');
    p.style.left=(Math.random()*100)+'vw';
    p.style.animationDelay=(Math.random()*0.5)+'s';
    p.style.background = Math.random()<.5?'linear-gradient(#80ffea,#4e9cff)':'linear-gradient(#ffd166,#ff3d7f)';
    el.appendChild(p);
  }
  setTimeout(()=>{el.innerHTML='';},1800);
}

/* ===== Log simple ===== */
function appendLog(entry){
  const key='cards_log';
  const arr = JSON.parse(localStorage.getItem(key)||'[]');
  arr.push(entry);
  localStorage.setItem(key, JSON.stringify(arr).slice(-500)); // guarda √∫ltimos (limit rudimentario)
}

/* ===== Estado / countdown ===== */
function restoreDaily(){
  const today=todayKey(); const stored=localStorage.getItem('cards_date');
  if(stored && stored!==today){
    ['cards_done','cards_prize','cards_code','cards_ts','cards_result','cards_winnerIndex'].forEach(k=>localStorage.removeItem(k));
    localStorage.setItem('cards_date',today);
  }else if(!stored){ localStorage.setItem('cards_date',today); }
}
function scheduleMidnightReset(){
  const now=new Date(); const midnight=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,0,0,5,0);
  setTimeout(()=>{['cards_done','cards_prize','cards_code','cards_ts','cards_result','cards_winnerIndex'].forEach(k=>localStorage.removeItem(k)); localStorage.setItem('cards_date',todayKey());
    title.textContent='Ten√©s 1 intento disponible'; subtitle.innerHTML='Los beneficios se aplican a tu <b>pr√≥xima carga</b>.';
    resultLine.textContent='‚Äî'; stampEl.textContent=''; badge.textContent='-'; document.getElementById('deck').innerHTML=''; buildDeck(); 
  }, midnight.getTime()-now.getTime());
}
function endOfDay(){const n=new Date();const end=new Date(n.getFullYear(),n.getMonth(),n.getDate(),23,59,0,0).getTime();
  return end>Date.now()?end:new Date(n.getFullYear(),n.getMonth(),n.getDate()+1,23,59,0,0).getTime()}
function tickCountdown(){
  const ms=endOfDay()-Date.now(); const total=Math.max(0,Math.floor(ms/1000));
  const h=Math.floor(total/3600), m=Math.floor((total%3600)/60), s=total%60;
  document.getElementById('countdown').textContent=h>0?`${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`:`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

/* ===== UI refs ===== */
const title = document.getElementById('title');
const subtitle = document.getElementById('subtitle');
const resultLine = document.getElementById('resultLine');
const stampEl = document.getElementById('stampLine');
const badge = document.getElementById('badge');
const wpQuick = document.getElementById('wpQuick');
const quickGameBtn = document.getElementById('quickGameBtn');
const retryBtn = document.getElementById('retryBtn');

/* ===== Modal refs ===== */
const prizeModal = document.getElementById('prizeModal');
const mPrize = document.getElementById('mPrize');
const mCode = document.getElementById('mCode');
const mTs = document.getElementById('mTs');
const mHint = document.getElementById('mHint');
const mGame = document.getElementById('mGame');
const mWp = document.getElementById('mWp');
const mPlatform = document.getElementById('mPlatform');
document.getElementById('closeModal').onclick = ()=> prizeModal.classList.remove('show');
prizeModal.addEventListener('click',e=>{ if(e.target===prizeModal) prizeModal.classList.remove('show'); });

/* ===== Deck / premios ===== */
const PRIZES = [
  {key:'COFRE MISTERIOSO', cls:'cofre',  desc:'Premio asegurado en su landing.'},
  {key:'MEMO PLAY',       cls:'memo',   desc:'Prob√° suerte en el Memory.'},
  {key:'OTRA CHANCE',     cls:'otra',   desc:'Pod√©s elegir otra carta.'},
  {key:'30% EXTRA',       cls:'co-30',  desc:'Pedilo por WhatsApp y aplic√° el extra en tu pr√≥xima carga.'},
  {key:'RULETA',          cls:'ruleta', desc:'Acced√© a la ruleta de beneficios.'},
  {key:'SLOT',            cls:'slot',   desc:'Gir√° por extra en la pr√≥xima carga.'}
];
// probabilidad simple: todas iguales (pod√©s ajustar ponderando √≠ndices)
function chooseWinnerIndex(){ return Math.floor(Math.random()*PRIZES.length); }

let picked=false, winnerIndex=null;

function buildCard(prize, index){
  const wrap = document.createElement('div');
  wrap.className='cardItem';
  const inner = document.createElement('div');
  inner.className='cardInner';
  const back = document.createElement('div');
  back.className='cardFace back';
  const btxt = document.createElement('div');
  btxt.className='bet'; btxt.textContent='BET300';
  back.appendChild(btxt);

  const front = document.createElement('div');
  front.className=`cardFace front ${prize.cls}`;
  front.innerHTML = `<h4>${prize.key}</h4><p>${prize.desc}</p>`;

  inner.appendChild(back); inner.appendChild(front); wrap.appendChild(inner);

  // interacci√≥n
  wrap.addEventListener('click', async ()=>{
    if(picked && index!==winnerIndex) return; // ignorar si ya se eligi√≥ otra
    if(soundOn) AudioKit.click(980, .08, .09);

    if(!picked){
      picked = true;
      // decidir ganador en el primer click
      winnerIndex = chooseWinnerIndex();
      localStorage.setItem('cards_winnerIndex', String(winnerIndex));
    }

    // girar todas (para mostrar opciones)
    revealAll();

    // marcar visualmente
    const inners = [...document.querySelectorAll('.cardInner')];
    inners.forEach((el,i)=> el.classList.toggle('winner', i===winnerIndex));
    inners.forEach((el,i)=> el.classList.toggle('loser',  i!==winnerIndex));

    const selectedPrize = PRIZES[winnerIndex];
    await grantPrize(selectedPrize);
  });

  return wrap;
}

function revealAll(){
  document.querySelectorAll('.cardInner').forEach(el=>el.classList.add('flip'));
}

function buildDeck(){
  const deck = document.getElementById('deck');
  deck.innerHTML='';
  // render inmediato con dorsos para que ‚Äúaparezca al instante‚Äù
  const order = [...PRIZES]; // si quer√©s mezclar: order.sort(()=>Math.random()-.5);
  order.forEach((p,i)=> deck.appendChild(buildCard(p,i)));
}

/* ===== Otorgamiento ===== */
async function grantPrize(p){
  // ya otorgado hoy?
  if(localStorage.getItem('cards_done')==='1'){
    showSaved(); return;
  }

  const prizeLabel = p.key;
  const code = await makeClaimCode(prizeLabel);
  const ts = tsString(new Date());

  // persistir
  localStorage.setItem('cards_code', code);
  localStorage.setItem('cards_ts', ts);
  localStorage.setItem('cards_prize', prizeLabel);
  localStorage.setItem('cards_result', prizeLabel);
  localStorage.setItem('cards_done','1');

  // UI derecha
  badge.textContent = prizeLabel.includes('%') ? prizeLabel : '-';
  title.textContent = `üéâ ${prizeLabel}`;
  subtitle.innerHTML = (prizeLabel==='30% EXTRA')
    ? `Pedilo por <b>WhatsApp</b>.`
    : `Abr√≠ la landing para usarlo en tu <b>pr√≥xima carga</b>.`;
  resultLine.textContent = `Resultado: ${prizeLabel}`;
  stampEl.textContent = `C√≥digo: ${code} ¬∑ ${ts}`;

  // Quick buttons (dock/top)
  const link = GAME_LINKS[prizeLabel];
  if(link){ quickGameBtn.href = link; quickGameBtn.style.display='inline-flex'; }
  else quickGameBtn.style.display='none';

  if(prizeLabel==='30% EXTRA'){
    const msg = encodeURIComponent(`Hola, tengo ${prizeLabel} de BET300 y quiero aplicarlo a mi pr√≥xima carga. C√≥digo: ${code} ¬∑ ${ts}`);
    const wplink = `https://wa.me/${WP}?text=${msg}`;
    mWp.href = wplink; mWp.style.display='inline-flex';
    wpQuick.href = wplink; wpQuick.style.display='inline-flex';
  }else{
    mWp.style.display='none';
    wpQuick.style.display='none';
  }

  // modal
  mPrize.textContent = prizeLabel;
  mCode.textContent  = code;
  mTs.textContent    = ts;
  mHint.textContent  = (prizeLabel==='30% EXTRA') ? 'Pedilo por WhatsApp y aplicalo en tu pr√≥xima carga.' : 'Abr√≠ el juego para continuar.';
  if(link){ mGame.href = link; mGame.style.display='inline-flex'; } else { mGame.style.display='none'; }
  prizeModal.classList.add('show');

  // confetti + sonido
  confettiBurst(); if(soundOn) AudioKit.win();

  // log
  appendLog({ts, pc:pcKey, device:DEVICE_ID, prize:prizeLabel, code});
}

function showSaved(){
  const prizeLabel = localStorage.getItem('cards_prize') || '‚Äî';
  const code = localStorage.getItem('cards_code') || '‚Äî';
  const ts = localStorage.getItem('cards_ts') || tsString();
  badge.textContent = prizeLabel.includes('%') ? prizeLabel : '-';
  title.textContent = `üéâ ${prizeLabel}`;
  subtitle.innerHTML = (prizeLabel==='30% EXTRA') ? `Pedilo por <b>WhatsApp</b>.` : `Abr√≠ la landing para usarlo.`;
  resultLine.textContent = `Resultado: ${prizeLabel}`;
  stampEl.textContent = `C√≥digo: ${code} ¬∑ ${ts}`;

  const link = GAME_LINKS[prizeLabel];
  if(link){ quickGameBtn.href = link; quickGameBtn.style.display='inline-flex'; }
  else quickGameBtn.style.display='none';

  if(prizeLabel==='30% EXTRA'){
    const msg = encodeURIComponent(`Hola, tengo ${prizeLabel} de BET300 y quiero aplicarlo a mi pr√≥xima carga. C√≥digo: ${code} ¬∑ ${ts}`);
    const wplink = `https://wa.me/${WP}?text=${msg}`;
    mWp.href = wplink; mWp.style.display='inline-flex';
    wpQuick.href = wplink; wpQuick.style.display='inline-flex';
  }else{
    mWp.style.display='none';
    wpQuick.style.display='none';
  }

  // girar todas y remarcar ganadora si existe
  const savedIndex = Number(localStorage.getItem('cards_winnerIndex'));
  if(!Number.isNaN(savedIndex)){
    winnerIndex = savedIndex; picked = true;
    revealAll();
    const inners = [...document.querySelectorAll('.cardInner')];
    inners.forEach((el,i)=> el.classList.toggle('winner', i===winnerIndex));
    inners.forEach((el,i)=> el.classList.toggle('loser',  i!==winnerIndex));
  }
}

/* ===== Otra chance (permite reintentar s√≥lo si el premio fue ‚ÄúOTRA CHANCE‚Äù) ===== */
retryBtn.addEventListener('click', ()=>{
  const last = localStorage.getItem('cards_prize');
  if(last === 'OTRA CHANCE'){
    ['cards_done','cards_prize','cards_code','cards_ts','cards_result','cards_winnerIndex'].forEach(k=>localStorage.removeItem(k));
    picked=false; winnerIndex=null;
    title.textContent='Ten√©s 1 intento disponible';
    subtitle.innerHTML='Los beneficios se aplican a tu <b>pr√≥xima carga</b>.';
    resultLine.textContent='‚Äî'; stampEl.textContent=''; badge.textContent='-';
    document.getElementById('deck').innerHTML=''; buildDeck();
    retryBtn.style.display='none';
  }else{
    alert('El reintento s√≥lo aplica cuando sali√≥ ‚ÄúOtra chance‚Äù.');
  }
});

/* ===== Init ===== */
function init(){
  document.getElementById('platformBtn').href = PLATFORM;
  document.getElementById('playNow').href = PLATFORM;

  restoreDaily();
  buildDeck();

  if(localStorage.getItem('cards_done')==='1') showSaved();

  // mostrar bot√≥n de reintento si corresponde
  if(localStorage.getItem('cards_prize')==='OTRA CHANCE'){ retryBtn.style.display='inline-flex'; }

  tickCountdown(); setInterval(tickCountdown,1000);
  scheduleMidnightReset();
}
init();
</script>
</body>
</html>
